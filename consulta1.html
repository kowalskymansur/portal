import streamlit as st
import pandas as pd
import requests
from datetime import datetime
import time
import io

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Sistema de Gest√£o de Itens",
    page_icon="üì¶",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS personalizado
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        color: white;
    }
    .upload-section {
        background-color: #f8f9fa;
        padding: 2rem;
        border-radius: 10px;
        border-left: 5px solid #007bff;
        margin-bottom: 2rem;
    }
    .success-box {
        background-color: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 5px;
        border-left: 5px solid #28a745;
        margin: 1rem 0;
    }
    .error-box {
        background-color: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 5px;
        border-left: 5px solid #dc3545;
        margin: 1rem 0;
    }
    .info-box {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 1rem;
        border-radius: 5px;
        border-left: 5px solid #17a2b8;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# Mock da API para demonstra√ß√£o
class MockAPI:
    def __init__(self):
        self.itens = []
        self.historico = []
    
    def adicionar_item(self, item):
        item['id'] = len(self.itens) + 1
        item['data_criacao'] = datetime.now().isoformat()
        item['data_atualizacao'] = datetime.now().isoformat()
        self.itens.append(item)
        return True
    
    def atualizar_item(self, item_id, dados):
        for item in self.itens:
            if item['id'] == item_id:
                item.update(dados)
                item['data_atualizacao'] = datetime.now().isoformat()
                return True
        return False
    
    def obter_itens(self):
        return self.itens
    
    def obter_item_por_id(self, item_id):
        for item in self.itens:
            if item['id'] == item_id:
                return item
        return None

# Inicializar mock API
if 'api' not in st.session_state:
    st.session_state.api = MockAPI()

# T√≠tulo principal
st.markdown('<div class="main-header">üì¶ Sistema de Gest√£o de Itens</div>', unsafe_allow_html=True)

# Se√ß√£o de Upload de Arquivo Excel
st.markdown('<div class="upload-section">', unsafe_allow_html=True)
st.subheader("üì§ Upload do Arquivo Excel para Atualiza√ß√£o em Massa")

uploaded_file = st.file_uploader(
    "Selecione o arquivo Excel para atualizar a lista de itens",
    type=['xlsx', 'xls'],
    help="Formatos suportados: .xlsx, .xls. O arquivo deve conter as colunas: C√≥digo, Nome, Quantidade, Pre√ßo"
)

st.markdown('</div>', unsafe_allow_html=True)

# Fun√ß√£o para validar o arquivo Excel
def validar_arquivo_excel(df):
    """Valida se o arquivo Excel tem a estrutura correta"""
    # Mapear colunas poss√≠veis
    mapeamento_colunas = {
        'codigo': ['codigo', 'c√≥digo', 'code', 'id', 'sku'],
        'nome': ['nome', 'name', 'produto', 'product', 'descricao', 'descri√ß√£o'],
        'quantidade': ['quantidade', 'quantity', 'qtd', 'stock'],
        'preco': ['preco', 'pre√ßo', 'price', 'valor', 'custo']
    }
    
    # Normalizar nomes das colunas
    df.columns = [str(col).lower().strip() for col in df.columns]
    
    # Tentar mapear colunas
    colunas_mapeadas = {}
    for coluna_alvo, alternativas in mapeamento_colunas.items():
        for alt in alternativas:
            if alt in df.columns:
                colunas_mapeadas[coluna_alvo] = alt
                break
    
    # Verificar se todas as colunas necess√°rias foram mapeadas
    colunas_necessarias = ['codigo', 'nome', 'quantidade', 'preco']
    for coluna in colunas_necessarias:
        if coluna not in colunas_mapeadas:
            return False, f"Coluna '{coluna}' n√£o encontrada. Colunas dispon√≠veis: {list(df.columns)}"
    
    # Renomear colunas
    df = df.rename(columns=colunas_mapeadas)
    
    # Verificar se h√° dados
    if df.empty:
        return False, "O arquivo est√° vazio"
    
    # Validar tipos de dados
    try:
        df['quantidade'] = pd.to_numeric(df['quantidade'], errors='coerce')
        df['preco'] = pd.to_numeric(df['preco'], errors='coerce')
        
        # Verificar valores NaN ap√≥s convers√£o
        if df['quantidade'].isna().any() or df['preco'].isna().any():
            return False, "Valores num√©ricos inv√°lidos encontrados"
            
    except Exception as e:
        return False, f"Erro na convers√£o de tipos num√©ricos: {str(e)}"
    
    return True, df

# Fun√ß√£o para processar o upload do arquivo
def processar_upload_arquivo(uploaded_file):
    """Processa o arquivo Excel e atualiza os itens"""
    try:
        # Ler o arquivo Excel
        df = pd.read_excel(uploaded_file)
        
        # Validar o arquivo
        valido, resultado = validar_arquivo_excel(df)
        
        if not valido:
            return False, resultado, []
        
        df_validado = resultado
        
        # Processar cada item
        itens_processados = 0
        itens_atualizados = 0
        erros = []
        
        for index, row in df_validado.iterrows():
            try:
                # Obter valores com fallback para valores opcionais
                codigo = str(row['codigo']).strip() if pd.notna(row['codigo']) else f"AUTO_{index+1}"
                nome = str(row['nome']).strip() if pd.notna(row['nome']) else "Sem nome"
                quantidade = int(row['quantidade']) if pd.notna(row['quantidade']) else 0
                preco = float(row['preco']) if pd.notna(row['preco']) else 0.0
                
                item = {
                    'codigo': codigo,
                    'nome': nome,
                    'quantidade': quantidade,
                    'preco': preco,
                    'categoria': str(row.get('categoria', 'Geral')).strip() if pd.notna(row.get('categoria')) else 'Geral',
                    'fornecedor': str(row.get('fornecedor', 'N√£o especificado')).strip() if pd.notna(row.get('fornecedor')) else 'N√£o especificado'
                }
                
                # Verificar se item j√° existe (por c√≥digo)
                item_existente = None
                for existing_item in st.session_state.api.itens:
                    if existing_item['codigo'] == item['codigo']:
                        item_existente = existing_item
                        break
                
                if item_existente:
                    # Atualizar item existente
                    st.session_state.api.atualizar_item(item_existente['id'], item)
                    itens_atualizados += 1
                else:
                    # Adicionar novo item
                    st.session_state.api.adicionar_item(item)
                    itens_processados += 1
                    
            except Exception as e:
                erros.append(f"Linha {index + 2}: {str(e)}")
        
        mensagem = f"Processamento conclu√≠do: {itens_processados} novos itens, {itens_atualizados} itens atualizados"
        if erros:
            mensagem += f", {len(erros)} erros"
            
        return True, mensagem, erros
        
    except Exception as e:
        return False, f"Erro ao processar o arquivo: {str(e)}", []

# Se o arquivo foi carregado
if uploaded_file is not None:
    col1, col2 = st.columns([3, 1])
    
    with col1:
        st.subheader("üìä Preview do Arquivo Carregado")
        
        try:
            # Ler e mostrar preview
            df_preview = pd.read_excel(uploaded_file)
            st.dataframe(df_preview.head(10), use_container_width=True)
            
            st.info(f"**Arquivo:** {uploaded_file.name} | **Registros:** {len(df_preview)} | **Colunas:** {list(df_preview.columns)}")
            
            # Estat√≠sticas b√°sicas
            if len(df_preview) > 0:
                col_stat1, col_stat2, col_stat3, col_stat4 = st.columns(4)
                
                with col_stat1:
                    st.metric("Total de Registros", len(df_preview))
                
                with col_stat2:
                    if 'quantidade' in df_preview.columns:
                        total_qtd = pd.to_numeric(df_preview['quantidade'], errors='coerce').sum()
                        st.metric("Qtd. Total", int(total_qtd))
                
                with col_stat3:
                    if 'preco' in df_preview.columns:
                        total_preco = pd.to_numeric(df_preview['preco'], errors='coerce').sum()
                        st.metric("Valor Total", f"R$ {total_preco:.2f}")
                
                with col_stat4:
                    st.metric("Status", "Pronto para processar")
            
            # Bot√£o para processar o arquivo
            st.markdown("---")
            st.subheader("üöÄ Processar Arquivo")
            
            if st.button("‚úÖ Processar e Atualizar Itens", type="primary", use_container_width=True):
                with st.spinner("Processando arquivo..."):
                    sucesso, mensagem, erros = processar_upload_arquivo(uploaded_file)
                
                if sucesso:
                    st.markdown(f'<div class="success-box">‚úÖ {mensagem}</div>', unsafe_allow_html=True)
                    
                    if erros:
                        st.markdown('<div class="error-box">‚ö†Ô∏è Erros encontrados:</div>', unsafe_allow_html=True)
                        for erro in erros:
                            st.write(f"‚Ä¢ {erro}")
                    
                    # Atualizar dados em tempo real
                    time.sleep(2)
                    st.rerun()
                    
                else:
                    st.markdown(f'<div class="error-box">‚ùå {mensagem}</div>', unsafe_allow_html=True)
        
        except Exception as e:
            st.error(f"Erro ao ler o arquivo: {str(e)}")
    
    with col2:
        st.subheader("‚ÑπÔ∏è Instru√ß√µes")
        
        st.markdown("""
        <div class="info-box">
        **Estrutura esperada:**
        - C√≥digo (obrigat√≥rio)
        - Nome (obrigat√≥rio)
        - Quantidade (obrigat√≥rio)
        - Pre√ßo (obrigat√≥rio)
        - Categoria (opcional)
        - Fornecedor (opcional)
        </div>
        """, unsafe_allow_html=True)
        
        # Template para download
        st.subheader("üìã Template")
        
        template_data = {
            'codigo': ['PROD001', 'PROD002', 'PROD003'],
            'nome': ['Produto Exemplo A', 'Produto Exemplo B', 'Produto Exemplo C'],
            'quantidade': [100, 50, 75],
            'preco': [29.90, 45.50, 12.75],
            'categoria': ['Eletr√¥nicos', 'M√≥veis', 'Decora√ß√£o'],
            'fornecedor': ['Fornecedor A', 'Fornecedor B', 'Fornecedor C']
        }
        template_df = pd.DataFrame(template_data)
        
        # Fun√ß√£o para converter DataFrame para Excel em mem√≥ria
        def convert_df_to_excel(df):
            output = io.BytesIO()
            with pd.ExcelWriter(output, engine='openpyxl') as writer:
                df.to_excel(writer, index=False, sheet_name='Template')
            output.seek(0)
            return output.getvalue()
        
        template_bytes = convert_df_to_excel(template_df)
        
        st.download_button(
            label="üì• Baixar Template Excel",
            data=template_bytes,
            file_name="template_itens.xlsx",
            mime="application/vnd.ms-excel",
            use_container_width=True
        )

# Restante do sistema de gest√£o
tab1, tab2, tab3 = st.tabs(["üìã Lista de Itens", "‚ûï Adicionar Item", "üìä Dashboard"])

with tab1:
    st.subheader("Lista de Itens Cadastrados")
    
    # Filtros
    col1, col2, col3 = st.columns(3)
    
    with col1:
        categorias_disponiveis = list(set([item.get('categoria', 'Geral') for item in st.session_state.api.itens]))
        filtro_categoria = st.selectbox(
            "Filtrar por categoria",
            ["Todas"] + categorias_disponiveis
        )
    
    with col2:
        fornecedores_disponiveis = list(set([item.get('fornecedor', 'N√£o especificado') for item in st.session_state.api.itens]))
        filtro_fornecedor = st.selectbox(
            "Filtrar por fornecedor",
            ["Todos"] + fornecedores_disponiveis
        )
    
    with col3:
        st.write("")  # Espa√ßamento
        if st.button("üîÑ Atualizar Lista"):
            st.rerun()
    
    # Aplicar filtros
    itens_filtrados = st.session_state.api.itens
    
    if filtro_categoria != "Todas":
        itens_filtrados = [item for item in itens_filtrados if item.get('categoria', 'Geral') == filtro_categoria]
    
    if filtro_fornecedor != "Todos":
        itens_filtrados = [item for item in itens_filtrados if item.get('fornecedor', 'N√£o especificado') == filtro_fornecedor]
    
    # Mostrar itens
    if itens_filtrados:
        for item in itens_filtrados:
            with st.expander(f"üì¶ {item['nome']} (C√≥digo: {item['codigo']})"):
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.write(f"**Quantidade:** {item['quantidade']}")
                    st.write(f"**Pre√ßo:** R$ {item['preco']:.2f}")
                
                with col2:
                    st.write(f"**Categoria:** {item.get('categoria', 'Geral')}")
                    st.write(f"**Fornecedor:** {item.get('fornecedor', 'N√£o especificado')}")
                
                with col3:
                    data_criacao = item.get('data_criacao', '')
                    data_atualizacao = item.get('data_atualizacao', '')
                    st.write(f"**Criado em:** {data_criacao[:10] if data_criacao else 'N/A'}")
                    st.write(f"**Atualizado em:** {data_atualizacao[:10] if data_atualizacao else 'N/A'}")
                
                with col4:
                    if st.button("‚úèÔ∏è Editar", key=f"edit_{item['id']}"):
                        st.session_state.editando_item = item['id']
                    
                    if st.button("üóëÔ∏è Excluir", key=f"delete_{item['id']}"):
                        st.session_state.api.itens = [i for i in st.session_state.api.itens if i['id'] != item['id']]
                        st.rerun()
    else:
        st.info("Nenhum item encontrado com os filtros aplicados.")

with tab2:
    st.subheader("Adicionar Novo Item")
    
    with st.form("form_adicionar_item"):
        col1, col2 = st.columns(2)
        
        with col1:
            codigo = st.text_input("C√≥digo do Item*", placeholder="Ex: PROD001")
            nome = st.text_input("Nome do Item*", placeholder="Ex: Notebook Dell")
            quantidade = st.number_input("Quantidade*", min_value=0, value=1)
        
        with col2:
            preco = st.number_input("Pre√ßo*", min_value=0.0, value=0.0, step=0.01)
            categoria = st.text_input("Categoria", placeholder="Ex: Eletr√¥nicos")
            fornecedor = st.text_input("Fornecedor", placeholder="Ex: Fornecedor A")
        
        submitted = st.form_submit_button("‚úÖ Adicionar Item")
        
        if submitted:
            if not codigo or not nome:
                st.error("C√≥digo e Nome s√£o obrigat√≥rios!")
            else:
                novo_item = {
                    'codigo': codigo,
                    'nome': nome,
                    'quantidade': quantidade,
                    'preco': preco,
                    'categoria': categoria or 'Geral',
                    'fornecedor': fornecedor or 'N√£o especificado'
                }
                
                if st.session_state.api.adicionar_item(novo_item):
                    st.success("Item adicionado com sucesso!")
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("Erro ao adicionar item.")

with tab3:
    st.subheader("Dashboard de Estoque")
    
    if st.session_state.api.itens:
        # M√©tricas principais
        col1, col2, col3, col4 = st.columns(4)
        
        total_itens = len(st.session_state.api.itens)
        total_quantidade = sum(item['quantidade'] for item in st.session_state.api.itens)
        valor_total = sum(item['quantidade'] * item['preco'] for item in st.session_state.api.itens)
        categorias = len(set(item.get('categoria', 'Geral') for item in st.session_state.api.itens))
        
        with col1:
            st.metric("Total de Itens", total_itens)
        with col2:
            st.metric("Quantidade Total", total_quantidade)
        with col3:
            st.metric("Valor Total em Estoque", f"R$ {valor_total:,.2f}")
        with col4:
            st.metric("Categorias", categorias)
        
        # Gr√°ficos e an√°lises
        col1, col2 = st.columns(2)
        
        with col1:
            # Distribui√ß√£o por categoria
            st.subheader("üìà Distribui√ß√£o por Categoria")
            categorias_df = pd.DataFrame([
                {'Categoria': item.get('categoria', 'Geral'), 'Quantidade': item['quantidade']}
                for item in st.session_state.api.itens
            ])
            
            if not categorias_df.empty:
                cat_sum = categorias_df.groupby('Categoria')['Quantidade'].sum().reset_index()
                st.bar_chart(cat_sum.set_index('Categoria'))
        
        with col2:
            # Top 10 itens mais valiosos
            st.subheader("üí∞ Itens Mais Valiosos")
            itens_valor = []
            for item in st.session_state.api.itens:
                valor_total_item = item['quantidade'] * item['preco']
                itens_valor.append({
                    'Item': item['nome'],
                    'Valor Total': valor_total_item
                })
            
            if itens_valor:
                valor_df = pd.DataFrame(itens_valor)
                valor_df = valor_df.nlargest(10, 'Valor Total')
                st.dataframe(valor_df, use_container_width=True)
    else:
        st.info("Nenhum item cadastrado para mostrar estat√≠sticas.")

# Rodap√©
st.markdown("---")
st.markdown("**Sistema de Gest√£o de Itens** ‚Ä¢ Desenvolvido com Streamlit ‚Ä¢ üìß Contato: suporte@empresa.com")

# Sidebar com informa√ß√µes adicionais
with st.sidebar:
    st.header("üîß Configura√ß√µes")
    
    st.subheader("Estat√≠sticas R√°pidas")
    if st.session_state.api.itens:
        st.write(f"**Itens cadastrados:** {len(st.session_state.api.itens)}")
        st.write(f"**Valor total:** R$ {sum(item['quantidade'] * item['preco'] for item in st.session_state.api.itens):,.2f}")
    else:
        st.write("Nenhum item cadastrado")
    
    st.subheader("A√ß√µes R√°pidas")
    if st.button("üîÑ Atualizar Sistema"):
        st.rerun()
    
    if st.button("üìä Gerar Relat√≥rio"):
        st.info("Relat√≥rio gerado com sucesso!")
    
    st.markdown("---")
    st.subheader("üí° Dicas")
    st.info("""
    - Use o upload de Excel para atualiza√ß√µes em massa
    - Mantenha os c√≥digos dos itens √∫nicos
    - Atualize regularmente as quantidades
    - Use categorias para melhor organiza√ß√£o
    """)