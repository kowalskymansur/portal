<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Redes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS DO SISTEMA PRINCIPAL */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #1abc9c;
            --bg-color: #f5f7fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #ddd;
            --header-bg: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--header-bg);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            align-items: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav a:hover, nav a.active {
            background-color: rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        main {
            padding: 2rem 0;
            min-height: calc(100vh - 140px);
        }

        .page-title {
            margin-bottom: 1.5rem;
            color: var(--dark);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #16a085;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .hidden {
            display: none !important;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--light);
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary);
        }

        .alert {
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .role-admin { background-color: #e74c3c; color: white; }
        .role-supervisao { background-color: #e67e22; color: white; }
        .role-analistas { background-color: #f39c12; color: white; }
        .role-tecnico { background-color: #3498db; color: white; }
        .role-projetos { background-color: #9b59b6; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 0.5rem;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .log-info { background-color: #d4edda; color: #155724; }
        .log-warning { background-color: #fff3cd; color: #856404; }
        .log-error { background-color: #f8d7da; color: #721c24; }
        .log-security { background-color: #cce7ff; color: #004085; }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .table-container {
            overflow-x: auto;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* CSS ESPEC√çFICO DO SISTEMA DE COORDENADAS */
        .abas-navegacao {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }

        .aba {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .aba.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: bold;
        }

        .aba:hover {
            background-color: #f8f9fa;
        }

        .conteudo-aba {
            display: none;
        }

        .conteudo-aba.active {
            display: block;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .destaque-pesquisa {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
            font-weight: bold;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
            gap: 5px;
        }

        .pagination button {
            padding: 0.5rem 0.75rem;
        }

        .pagination button.active {
            background-color: var(--primary);
        }

        .pagination-info {
            text-align: center;
            margin-top: 1rem;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 1rem;
        }

        .info-pesquisa {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .stats-info {
            background-color: #e8f4fd;
            border-left: 4px solid var(--secondary);
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .search-input-container {
            flex: 2;
            position: relative;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-input-coordenadas {
            padding-left: 35px;
            width: 100%;
        }

        .categoria-select {
            min-width: 220px;
            flex: 1;
        }

        .btn-limpar {
            min-width: 100px;
            flex-shrink: 0;
        }

        .copy-button-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 10px;
        }

        .option-with-count {
            display: flex;
            justify-content: space-between;
        }

        .option-count {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 10px;
        }

        /* Toast para notifica√ß√µes */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background-color: var(--danger);
        }

        /* CSS ESPEC√çFICO DO SISTEMA DE MATERIAIS */
        .tabs-materiais {
            display: flex;
            margin: 20px 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .tab-materiais {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-materiais.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
            font-weight: bold;
        }
        
        .tab-content-materiais {
            display: none;
        }
        
        .tab-content-materiais.active {
            display: block;
        }
        
        .search-container-materiais {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .search-bar-materiais {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input-container-materiais {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        .search-input-container-materiais input {
            width: 100%;
            padding: 10px 40px 10px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .clear-search-materiais {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: none;
        }
        
        .clear-search-materiais:hover {
            color: var(--danger);
        }
        
        .search-bar-materiais select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .btn-materiais {
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 36px;
            white-space: nowrap;
        }
        
        .btn-edit-materiais {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-edit-materiais:hover {
            background-color: #e67e22;
        }
        
        .btn-delete-materiais {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-delete-materiais:hover {
            background-color: #c0392b;
        }

        .btn-save-materiais {
            background-color: var(--success);
            color: white;
        }
        
        .btn-save-materiais:hover {
            background-color: #27ae60;
        }
        
        .form-container-materiais {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .form-group-materiais {
            margin-bottom: 15px;
        }
        
        .form-group-materiais label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group-materiais input, .form-group-materiais select, .form-group-materiais textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-group-materiais textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row-materiais {
            display: flex;
            gap: 15px;
        }
        
        .form-row-materiais .form-group-materiais {
            flex: 1;
        }
        
        .form-actions-materiais {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary-materiais {
            background-color: var(--secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary-materiais:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary-materiais {
            background-color: #95a5a6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-secondary-materiais:hover {
            background-color: #7f8c8d;
        }
        
        .no-results-materiais {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .form-title-materiais {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-options-materiais {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-btn-materiais {
            background-color: var(--info);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .export-btn-materiais:hover {
            background-color: #16a085;
        }
        
        .validation-error-materiais {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .input-error-materiais {
            border-color: var(--danger) !important;
        }

        .status-message-materiais {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }

        .status-success-materiais {
            background-color: var(--success);
            color: white;
        }

        .status-error-materiais {
            background-color: var(--danger);
            color: white;
        }

        .status-warning-materiais {
            background-color: var(--warning);
            color: white;
        }

        .status-info-materiais {
            background-color: var(--info);
            color: white;
        }

        .categoria-actions-materiais {
            display: flex;
            gap: 5px;
        }

        /* NOVOS ESTILOS PARA SISTEMA DE MATERIAIS COMPLETO */
        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .selection-info {
            font-size: 14px;
            color: var(--text-color);
        }

        .copy-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .copy-btn:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .copy-btn:hover:not(:disabled) {
            background-color: #2d9e64;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .select-all input {
            cursor: pointer;
        }

        .solicitacao-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .solicitacao-itens {
            flex: 2;
        }

        .solicitacao-form {
            flex: 1;
        }

        .email-preview {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .email-preview h4 {
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .email-preview-content {
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
        }

        .btn-outlook {
            background-color: #0072C6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .btn-outlook:hover {
            background-color: #005a9e;
        }

        .btn-outlook:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quantidade-input {
            width: 80px;
            padding: 6px 8px;
            border: 1.5px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            text-align: center;
        }

        .quantidade-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.1);
        }

        .quantidade-input.invalid {
            border-color: var(--danger);
        }

        .categoria-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .categoria-item:last-child {
            border-bottom: none;
        }

        .categoria-actions {
            display: flex;
            gap: 5px;
        }

        .tooltip {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--success);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .history-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input-container,
            .categoria-select,
            .btn-limpar {
                width: 100%;
                min-width: auto;
            }

            .search-bar-materiais {
                flex-direction: column;
            }
            
            .form-row-materiais {
                flex-direction: column;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .actions {
                flex-direction: column;
            }

            .categoria-actions-materiais {
                flex-direction: column;
            }
            
            .selection-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .solicitacao-container {
                flex-direction: column;
            }

            .categoria-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .categoria-actions {
                width: 100%;
                justify-content: flex-end;
                flex-direction: row !important;
            }
        }
    </style>
</head>
<body>
    <!-- P√°gina de Login -->
    <div id="login-page" class="login-container">
        <div class="login-form">
            <h2>üåê Gest√£o de Redes</h2>
            <div id="login-alert" class="alert alert-danger hidden"></div>
            <div id="setup-status" class="alert alert-info hidden"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required value="admin@sistema.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" required value="Kowa2013">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-primary" style="width: 100%;" id="login-button">Entrar</button>
                </div>
                <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                    <strong>Credenciais padr√£o pr√©-preenchidas</strong>
                </div>
            </form>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="main-system" class="hidden">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <span>üåê</span>
                    <h1>Gest√£o de Redes</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" id="nav-dashboard" class="nav-link active">Dashboard</a></li>
                        <li><a href="#" id="nav-usuarios" class="nav-link">Usu√°rios</a></li>
                        <li><a href="#" id="nav-coordenadas" class="nav-link">Coordenadas</a></li>
                        <li><a href="#" id="nav-materiais" class="nav-link">Materiais</a></li>
                        <li><a href="#" id="nav-log" class="nav-link">Logs</a></li>
                        <li><a href="#" id="nav-relatorios" class="nav-link">Relat√≥rios</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <span id="user-name">Administrador</span>
                    <span class="role-badge" id="user-role">Administrador</span>
                    <button class="logout-btn" id="logout-btn">Sair</button>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- P√°gina Dashboard -->
            <section id="page-dashboard" class="page-content active">
                <h2 class="page-title"><span>üìä</span>Dashboard</h2>
                
                <div class="card">
                    <h3 id="welcome-message">Bem-vindo!</h3>
                    <p>Seu n√≠vel de acesso: <span id="user-role-badge" class="role-badge role-admin">Administrador</span></p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total de Usu√°rios</h3>
                            <div class="stat-number" id="total-usuarios">1</div>
                        </div>
                        <div class="stat-card">
                            <h3>Coordenadas</h3>
                            <div class="stat-number" id="total-coordenadas">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Materiais</h3>
                            <div class="stat-number" id="total-materiais">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Status do Sistema</h3>
                            <div class="stat-number">‚úÖ</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Funcionalidades do Sistema</h3>
                    <div style="padding: 1rem;">
                        <p>‚úÖ <strong>Sistema carregado com sucesso!</strong></p>
                        <p>üéØ <strong>Funcionalidades dispon√≠veis:</strong></p>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li><strong>Usu√°rios:</strong> Gerenciamento completo de usu√°rios e hierarquias</li>
                            <li><strong>Coordenadas:</strong> Sistema de geolocaliza√ß√£o e mapeamento</li>
                            <li><strong>Materiais:</strong> Controle de invent√°rio e estoque</li>
                            <li><strong>Logs:</strong> Auditoria completa do sistema</li>
                            <li><strong>Relat√≥rios:</strong> Exporta√ß√£o de dados e relat√≥rios</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3>Atividades Recentes</h3>
                    <div style="padding: 1rem;" id="atividades-recentes">
                        <div class="log-entry">
                            <div>
                                <strong>Login realizado com sucesso</strong>
                                <div style="font-size: 0.875rem; color: #666; margin-top: 5px;">
                                    <span id="login-user">Usu√°rio</span> | <span id="login-time"></span>
                                </div>
                            </div>
                            <span class="log-type log-info">INFO</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- P√°gina Usu√°rios -->
            <section id="page-usuarios" class="page-content">
                <h2 class="page-title"><span>üë•</span>Gerenciar Usu√°rios</h2>
                
                <div class="card">
                    <div class="search-bar">
                        <input type="text" id="search-usuarios" placeholder="Buscar usu√°rios..." class="search-input">
                        <button id="btn-novo-usuario" class="btn-success">+ Novo Usu√°rio</button>
                    </div>

                    <div class="table-container">
                        <table id="tabela-usuarios">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Hierarquia</th>
                                    <th>Status</th>
                                    <th>Data Cadastro</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-usuarios">
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- P√°gina Coordenadas -->
            <section id="page-coordenadas" class="page-content">
                <h2 class="page-title">
                    <span>üìç</span>
                    Gerenciar Coordenadas
                </h2>
                
                <!-- Conte√∫do da aba Consulta -->
                <div class="card">
                    <div id="info-pesquisa" class="info-pesquisa hidden">
                        <!-- Informa√ß√µes sobre a pesquisa ser√£o inseridas aqui -->
                    </div>
                    
                    <div class="search-bar">
                        <div class="search-input-container">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="search-input" class="search-input-coordenadas" placeholder="Digite para pesquisar por nome, localiza√ß√£o ou tipo (separado por ; sem espa√ßos)">
                        </div>
                        <select id="tipo-local-select" class="categoria-select">
                            <option value="">Todos os Tipos de Local</option>
                            <!-- Tipos de local ser√£o carregados dinamicamente -->
                        </select>
                        <button id="btn-limpar-pesquisa" class="btn-danger btn-limpar">Limpar</button>
                    </div>
                    
                    <!-- Bot√£o de c√≥pia e exclus√£o -->
                    <div class="copy-button-container">
                        <button id="btn-copiar" class="btn-success">Copiar</button>
                        <button id="btn-excluir-coordenadas" class="btn-danger hidden">Excluir Selecionadas</button>
                    </div>
                    
                    <div class="table-container">
                        <div id="loading-coordenadas" class="loading hidden">
                            <div class="loading-spinner"></div>
                            <p>Carregando coordenadas...</p>
                        </div>
                        <table id="tabela-coordenadas">
                            <thead>
                                <tr>
                                    <th class="checkbox-column">Selecionar</th>
                                    <th>Nome</th>
                                    <th>Tipo de Local</th>
                                    <th>Latitude (Y)</th>
                                    <th>Longitude (X)</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-corpo">
                                <!-- Linhas de coordenadas ser√£o inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="empty-state" class="empty-state hidden">
                        <div class="empty-state-icon">üó∫Ô∏è</div>
                        <p>Nenhuma coordenada encontrada.</p>
                    </div>

                    <!-- Controles de pagina√ß√£o -->
                    <div id="pagination-controls" class="pagination hidden">
                        <!-- Bot√µes de pagina√ß√£o ser√£o inseridos aqui -->
                    </div>
                    
                    <div id="pagination-info" class="pagination-info hidden">
                        <!-- Informa√ß√µes da pagina√ß√£o ser√£o inseridas aqui -->
                    </div>

                    <!-- Estat√≠sticas de carregamento -->
                    <div id="stats-info" class="stats-info hidden">
                        <strong>üìä Estat√≠sticas de Carregamento:</strong> 
                        <span id="stats-text">Carregando estat√≠sticas...</span>
                    </div>
                </div>
            </section>

            <!-- P√°gina Materiais - SISTEMA COMPLETO -->
            <section id="page-materiais" class="page-content">
                <h2 class="page-title"><span>üì¶</span>Gerenciar Materiais</h2>
                
                <div id="statusMessageMateriais" class="status-message-materiais" style="display: none;"></div>
                
                <div class="tabs-materiais">
                    <div class="tab-materiais active" data-tab="consultar-materiais"><i class="fas fa-search"></i> Consultar Materiais</div>
                    <div class="tab-materiais" data-tab="cadastrar-materiais"><i class="fas fa-plus-circle"></i> Cadastrar/Editar Material</div>
                    <div class="tab-materiais" data-tab="categorias-materiais"><i class="fas fa-tags"></i> Gerenciar Categorias</div>
                    <div class="tab-materiais" data-tab="solicitacao-materiais"><i class="fas fa-envelope"></i> Solicitar Materiais</div>
                    <div class="tab-materiais" data-tab="historico-materiais"><i class="fas fa-history"></i> Hist√≥rico</div>
                </div>

                <div class="tab-content-materiais active" id="consultar-materiais">
                    <div class="search-container-materiais">
                        <div class="search-bar-materiais">
                            <div class="search-input-container-materiais">
                                <input type="text" id="searchInputMateriais" placeholder="Pesquisar por c√≥digo, descri√ß√£o ou observa√ß√µes...">
                                <button class="clear-search-materiais" id="clearSearchMateriais" title="Limpar pesquisa">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <select id="categoryFilterMateriais">
                                <option value="">Todas as categorias</option>
                            </select>
                            <button id="searchButtonMateriais" class="btn-primary-materiais"><i class="fas fa-search"></i> Pesquisar</button>
                        </div>
                    </div>

                    <div class="selection-controls">
                        <div class="select-all">
                            <input type="checkbox" id="selectAllMateriais">
                            <label for="selectAllMateriais">Selecionar todos</label>
                        </div>
                        <div class="selection-info" id="selectionInfoMateriais">Nenhum item selecionado</div>
                        <button class="copy-btn" id="copySelectedMateriais" disabled>
                            <i class="fas fa-copy"></i> Copiar Selecionados
                        </button>
                    </div>

                    <div id="resultsContainerMateriais">
                        <table id="resultsTableMateriais">
                            <thead>
                                <tr>
                                    <th width="50px"></th>
                                    <th>C√≥digo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Observa√ß√µes</th>
                                    <th>Categoria</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBodyMateriais">
                                <tr>
                                    <td colspan="6" class="no-results-materiais">
                                        <i class="fas fa-spinner fa-spin"></i> Carregando materiais...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="pagination" id="paginationMateriais"></div>
                    </div>
                </div>

                <div class="tab-content-materiais" id="cadastrar-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais" id="formTitleMateriais"><i class="fas fa-plus-circle"></i> Cadastrar Novo Material</h2>
                        <form id="materialForm">
                            <div class="form-row-materiais">
                                <div class="form-group-materiais">
                                    <label for="codigo" class="required">C√≥digo *</label>
                                    <input type="text" id="codigo" required>
                                    <div class="validation-error-materiais" id="codigoError">C√≥digo j√° existe ou √© inv√°lido</div>
                                </div>
                                
                                <div class="form-group-materiais">
                                    <label for="categoria" class="required">Categoria *</label>
                                    <select id="categoria" required>
                                        <option value="">Selecione uma categoria</option>
                                    </select>
                                    <div class="validation-error-materiais" id="categoriaError">Selecione uma categoria v√°lida</div>
                                </div>
                            </div>
                            
                            <div class="form-group-materiais">
                                <label for="descricao" class="required">Descri√ß√£o do Produto *</label>
                                <input type="text" id="descricao" required>
                                <div class="validation-error-materiais" id="descricaoError">Descri√ß√£o √© obrigat√≥ria</div>
                            </div>
                            
                            <div class="form-group-materiais">
                                <label for="observacoes">Observa√ß√µes</label>
                                <textarea id="observacoes"></textarea>
                            </div>
                            
                            <div class="form-actions-materiais">
                                <button type="button" class="btn-secondary-materiais" id="cancelButtonMateriais">Cancelar</button>
                                <button type="submit" class="btn-primary-materiais" id="submitButtonMateriais"><i class="fas fa-save"></i> Cadastrar Material</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="tab-content-materiais" id="categorias-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais"><i class="fas fa-tags"></i> Gerenciar Categorias</h2>
                        <div class="form-row-materiais">
                            <div class="form-group-materiais">
                                <label for="novaCategoria">Nova Categoria</label>
                                <input type="text" id="novaCategoria" placeholder="Digite o nome da nova categoria">
                            </div>
                            <div class="form-group-materiais">
                                <label>&nbsp;</label>
                                <button class="btn-primary-materiais" id="addCategoria"><i class="fas fa-plus"></i> Adicionar Categoria</button>
                            </div>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">Categorias Existentes</h3>
                        <div id="categoriasList">
                            <p>Carregando categorias...</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content-materiais" id="solicitacao-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais"><i class="fas fa-envelope"></i> Solicita√ß√£o de Materiais</h2>
                        
                        <div class="solicitacao-container">
                            <div class="solicitacao-itens">
                                <h3>Itens Selecionados para Solicita√ß√£o</h3>
                                <div class="selection-controls">
                                    <div class="selection-info" id="solicitacaoSelectionInfo">Nenhum item selecionado</div>
                                </div>
                                <div id="solicitacaoResultsContainer">
                                    <table id="solicitacaoResultsTable">
                                        <thead>
                                            <tr>
                                                <th width="50px"></th>
                                                <th width="100px">Quantidade</th>
                                                <th>C√≥digo</th>
                                                <th>Descri√ß√£o</th>
                                                <th>Categoria</th>
                                            </tr>
                                        </thead>
                                        <tbody id="solicitacaoResultsBody">
                                            <tr>
                                                <td colspan="5" class="no-results-materiais">
                                                    <i class="fas fa-info-circle"></i> Nenhum item adicionado √† solicita√ß√£o
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="solicitacao-form">
                                <div class="form-group-materiais">
                                    <label for="tecnico" class="required">T√©cnico</label>
                                    <select id="tecnico" required>
                                        <option value="">Selecione o t√©cnico</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-materiais">
                                    <label>Pr√©via do Email</label>
                                    <div class="email-preview">
                                        <h4>Assunto: <span id="emailAssunto">Solicita√ß√£o de material - </span></h4>
                                        <div class="email-preview-content" id="emailPreview">
                                            Selecione um t√©cnico e itens para visualizar o email.
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn-outlook" id="enviarOutlook" disabled>
                                    <i class="fas fa-paper-plane"></i> Abrir no Outlook
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content-materiais" id="historico-materiais">
                    <div class="form-container-materiais">
                        <h2 class="form-title-materiais"><i class="fas fa-history"></i> Hist√≥rico de Altera√ß√µes</h2>
                        <div class="history-container" id="historyList">
                            <p>Carregando hist√≥rico...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- P√°gina Logs -->
            <section id="page-log" class="page-content">
                <h2 class="page-title"><span>üìã</span>Logs do Sistema</h2>
                
                <div class="card">
                    <div class="search-bar">
                        <input type="text" id="search-logs" placeholder="Buscar em logs..." class="search-input">
                        <select id="filter-tipo-log">
                            <option value="">Todos os tipos</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="security">Security</option>
                        </select>
                        <button id="btn-limpar-logs" class="btn-warning">Limpar Filtros</button>
                    </div>

                    <div class="table-container">
                        <table id="tabela-logs">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usu√°rio</th>
                                    <th>Tipo</th>
                                    <th>Mensagem</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-logs">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <div>üìã</div>
                                        <p>Nenhum log encontrado</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- P√°gina Relat√≥rios -->
            <section id="page-relatorios" class="page-content">
                <h2 class="page-title"><span>üìà</span>Relat√≥rios</h2>
                
                <div class="card">
                    <h3>Gerar Relat√≥rios</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-tipo">Tipo de Relat√≥rio</label>
                            <select id="relatorio-tipo" class="form-control">
                                <option value="usuarios">Relat√≥rio de Usu√°rios</option>
                                <option value="coordenadas">Relat√≥rio de Coordenadas</option>
                                <option value="materiais">Relat√≥rio de Materiais</option>
                                <option value="logs">Relat√≥rio de Logs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="relatorio-periodo">Per√≠odo</label>
                            <select id="relatorio-periodo" class="form-control">
                                <option value="hoje">Hoje</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes">Este M√™s</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" id="periodo-personalizado" style="display: none;">
                        <div class="form-group">
                            <label for="data-inicio">Data In√≠cio</label>
                            <input type="date" id="data-inicio" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="data-fim">Data Fim</label>
                            <input type="date" id="data-fim" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="relatorio-formato">Formato</label>
                        <select id="relatorio-formato" class="form-control">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>

                    <button id="btn-gerar-relatorio" class="btn-primary">Gerar Relat√≥rio</button>
                </div>

                <div class="card">
                    <h3>Relat√≥rios Recentes</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome do Relat√≥rio</th>
                                    <th>Data Gera√ß√£o</th>
                                    <th>Tipo</th>
                                    <th>Formato</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <div>üìà</div>
                                        <p>Nenhum relat√≥rio gerado ainda</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast para notifica√ß√µes -->
    <div id="toast" class="toast"></div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://tfdniuwqjqvscwiypbuo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmZG5pdXdxanF2c2N3aXlwYnVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MjU1OTgsImV4cCI6MjA3NzUwMTU5OH0.ZeIef1hnlE4W10xD8Z23hiNEoOTdseNj_ox13uqchA0';
        const TABELA_COORDENADAS = 'coordenadas';
        const TABELA_CAIXAS = 'cx_disponiveis';
        const TABELA_MATERIAIS = 'materiais';
        const TABELA_CATEGORIAS = 'categorias';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Vari√°veis globais
        let usuarioLogado = null;
        
        // Vari√°veis do sistema de coordenadas
        let tiposDeLocalCache = [];
        let paginaAtual = 1;
        const itensPorPagina = 10;
        let coordenadasFiltradas = [];
        let itemPesquisadoIndex = -1;
        let modoPesquisaContexto = false;
        let coordenadasSelecionadas = [];
        let colunaIdCoordenadas = null;

        // Vari√°veis do sistema de materiais
        let materiais = [];
        let categorias = [];
        let editandoMaterial = false;
        let codigoEditando = null;
        let editandoCategoriaIndex = null;
        let currentPageMateriais = 1;
        const itemsPerPageMateriais = 10;
        let searchTimeoutMateriais;
        let selectedItemsMateriais = new Set();
        let solicitacaoItemsMateriais = new Map();

        // Lista de t√©cnicos para solicita√ß√£o de materiais
        const tecnicos = [
            "Adilson de Oliveira",
            "Rodrigo de Lima Vicente",
            "Dhiobert dos Santos Bertolino",
            "Vagner Cesar da Silva",
            "Weksley de Oliveira Queiroz",
            "Wellington da Silva de Souza",
            "Erman de Souza dos Santos",
            "M√°rio S√©rgio Rezende da Silva",
            "Daniel Fernando Filipe Quirino",
            "Ramom da Silva Moreira",
            "Calebe de Andrade Garcia",
            "La√©rcio Silva Rosa",
            "Pablo da Silva Veloso",
            "Jonatan de Souza Nascimento",
            "Geremias de Moura Vieira",
            "Douglas Silva Falc√£o",
            "Ailton J√∫nior da Silva Moreira",
            "Josiel Moreira da Silva",
            "Cosme Jos√© Alves",
            "Felipe Coste Dias",
            "Daniel Moura",
            "Marcelo",
            "Jackson Sampaio de Souza",
            "Igor",
            "Vinicius dos Santos Oliveira",
            "Geovani Silv√©rio De Andrade",
            "FHM Telecom",
            "TurboNet"
        ];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando sistema de gest√£o de redes...');
            inicializarSistema();
        });

        // Inicializar sistema
        async function inicializarSistema() {
            try {
                mostrarStatusSetup('üîç Verificando configura√ß√£o do sistema...');
                
                // Verificar se podemos acessar o banco
                const bancoAcessivel = await verificarAcessoBanco();
                
                if (bancoAcessivel) {
                    mostrarStatusSetup('‚úÖ Banco de dados acess√≠vel! Verificando usu√°rio administrador...');
                    
                    // Verificar e corrigir o usu√°rio admin se necess√°rio
                    await verificarECorrigirUsuarioAdmin();
                    
                    mostrarStatusSetup('‚úÖ Sistema pronto! Voc√™ pode fazer login.');
                } else {
                    mostrarStatusSetup('‚ùå N√£o foi poss√≠vel acessar o banco de dados. Verifique a conex√£o.');
                }
                
                // Configurar event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o do sistema:', error);
                mostrarAlertaLogin('Erro ao inicializar sistema: ' + error.message);
            }
        }

        // Verificar acesso ao banco
        async function verificarAcessoBanco() {
            try {
                // Tentar uma consulta simples para verificar se a tabela existe
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('count')
                    .limit(1);

                if (error) {
                    console.error('‚ùå Erro ao acessar banco:', error);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao verificar acesso ao banco:', error);
                return false;
            }
        }

        // Verificar e corrigir usu√°rio admin
        async function verificarECorrigirUsuarioAdmin() {
            try {
                console.log('üë§ Verificando usu√°rio administrador...');
                
                // Buscar usu√°rio admin
                const { data: usuarioExistente, error: erroBusca } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', 'admin@sistema.com')
                    .single();

                if (erroBusca && erroBusca.code === 'PGRST116') {
                    // Usu√°rio n√£o existe, vamos criar
                    console.log('‚ûï Criando usu√°rio administrador...');
                    await criarUsuarioAdmin();
                } else if (erroBusca) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', erroBusca);
                    throw erroBusca;
                } else {
                    console.log('‚úÖ Usu√°rio administrador encontrado');
                    
                    // Verificar se a senha est√° correta
                    const senhaCorreta = await verificarSenhaUsuario(usuarioExistente);
                    if (!senhaCorreta) {
                        console.log('üîß Corrigindo senha do usu√°rio administrador...');
                        await corrigirSenhaUsuario(usuarioExistente.id);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar/corrigir usu√°rio admin:', error);
                throw error;
            }
        }

        // Verificar senha do usu√°rio
        async function verificarSenhaUsuario(usuario) {
            try {
                const senhaTeste = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaTeste).toString();
                return usuario.senha === senhaCriptografada;
            } catch (error) {
                console.error('‚ùå Erro ao verificar senha:', error);
                return false;
            }
        }

        // Corrigir senha do usu√°rio
        async function corrigirSenhaUsuario(usuarioId) {
            try {
                const senhaCorreta = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaCorreta).toString();
                
                const { error } = await supabase
                    .from('usuarios')
                    .update({ senha: senhaCriptografada })
                    .eq('id', usuarioId);

                if (error) {
                    throw error;
                }
                
                console.log('‚úÖ Senha do usu√°rio administrador corrigida!');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao corrigir senha:', error);
                throw error;
            }
        }

        // Criar usu√°rio administrador
        async function criarUsuarioAdmin() {
            try {
                console.log('‚ûï Criando usu√°rio administrador...');
                
                // Calcular o hash SHA256 correto para "Kowa2013"
                const senhaCorreta = 'Kowa2013';
                const senhaCriptografada = CryptoJS.SHA256(senhaCorreta).toString();
                
                console.log('üîë Hash SHA256 da senha:', senhaCriptografada);
                
                const usuarioAdmin = {
                    nome: 'Administrador',
                    email: 'admin@sistema.com',
                    senha: senhaCriptografada,
                    hierarquia: 'Administrador',
                    status: 'ativo',
                    data_cadastro: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('usuarios')
                    .insert([usuarioAdmin])
                    .select()
                    .single();

                if (error) {
                    console.error('‚ùå Erro ao criar usu√°rio admin:', error);
                    throw new Error('N√£o foi poss√≠vel criar o usu√°rio administrador: ' + error.message);
                }

                console.log('‚úÖ Usu√°rio administrador criado com sucesso!');
                console.log('üìß Email: admin@sistema.com');
                console.log('üîë Senha: Kowa2013');
                console.log('üîê Hash: ' + senhaCriptografada);
                
                return data;
                
            } catch (error) {
                console.error('‚ùå Erro ao criar usu√°rio admin:', error);
                throw error;
            }
        }

        // Mostrar status do setup
        function mostrarStatusSetup(mensagem) {
            const setupStatus = document.getElementById('setup-status');
            if (setupStatus) {
                setupStatus.textContent = mensagem;
                setupStatus.classList.remove('hidden');
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            const loginForm = document.getElementById('login-form');
            
            if (loginForm) {
                loginForm.addEventListener('submit', fazerLogin);
            }
        }

        // Fazer login
        async function fazerLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-password').value;
            const loginButton = document.getElementById('login-button');
            
            if (!email || !senha) {
                mostrarAlertaLogin('Preencha todos os campos');
                return;
            }

            // Mostrar loading
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.textContent = 'Entrando...';
            }

            try {
                console.log('üîê Tentando login...');
                
                // Buscar usu√°rio no Supabase
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (error) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', error);
                    
                    if (error.code === 'PGRST116') {
                        throw new Error('Usu√°rio n√£o encontrado');
                    }
                    throw error;
                }
                
                console.log('üë§ Usu√°rio encontrado:', data);
                
                // Verificar status
                if (data.status !== 'ativo') {
                    throw new Error('Usu√°rio inativo. Contate o administrador.');
                }
                
                // Verificar senha
                const senhaCriptografada = CryptoJS.SHA256(senha).toString();
                
                if (data.senha !== senhaCriptografada) {
                    throw new Error('Senha incorreta');
                }
                
                // Login bem-sucedido
                usuarioLogado = data;
                localStorage.setItem('usuario_logado', JSON.stringify(data));
                
                console.log('‚úÖ Login realizado com sucesso');
                mostrarSistemaPrincipal();
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                mostrarAlertaLogin(error.message);
            } finally {
                // Restaurar bot√£o
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                }
            }
        }

        // Mostrar alerta de login
        function mostrarAlertaLogin(mensagem) {
            const loginAlert = document.getElementById('login-alert');
            if (loginAlert) {
                loginAlert.textContent = mensagem;
                loginAlert.classList.remove('hidden');
                
                setTimeout(() => {
                    loginAlert.classList.add('hidden');
                }, 5000);
            }
        }

        // Mostrar sistema principal
        function mostrarSistemaPrincipal() {
            console.log('üéØ Mostrando sistema principal...');
            
            const loginPage = document.getElementById('login-page');
            const mainSystem = document.getElementById('main-system');
            
            if (loginPage && mainSystem) {
                // Ocultar login
                loginPage.classList.add('hidden');
                
                // Mostrar sistema principal
                mainSystem.classList.remove('hidden');
                
                // Atualizar interface com dados do usu√°rio
                atualizarInterfaceUsuario();
                
                console.log('‚úÖ Sistema principal carregado com sucesso!');
            } else {
                console.error('‚ùå Elementos n√£o encontrados');
            }
        }

        // Atualizar interface com dados do usu√°rio
        function atualizarInterfaceUsuario() {
            if (!usuarioLogado) return;
            
            // Atualizar informa√ß√µes do usu√°rio
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userRole = document.getElementById('user-role');
            const welcomeMessage = document.getElementById('welcome-message');
            const userRoleBadge = document.getElementById('user-role-badge');
            const loginUser = document.getElementById('login-user');
            const loginTime = document.getElementById('login-time');
            
            if (userAvatar) userAvatar.textContent = usuarioLogado.nome.charAt(0).toUpperCase();
            if (userName) userName.textContent = usuarioLogado.nome;
            if (userRole) userRole.textContent = usuarioLogado.hierarquia;
            if (welcomeMessage) welcomeMessage.textContent = `Bem-vindo, ${usuarioLogado.nome}!`;
            if (userRoleBadge) {
                userRoleBadge.textContent = usuarioLogado.hierarquia;
                userRoleBadge.className = `role-badge role-${usuarioLogado.hierarquia.toLowerCase().replace('√£', 'a').replace('√ß', 'c')}`;
            }
            if (loginUser) loginUser.textContent = usuarioLogado.nome;
            if (loginTime) loginTime.textContent = new Date().toLocaleString('pt-BR');
            
            // Configurar event listeners do sistema
            configurarEventListenersSistema();
        }

        // FUN√á√ïES DE NAVEGA√á√ÉO E P√ÅGINAS
        function configurarEventListenersSistema() {
            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    usuarioLogado = null;
                    localStorage.removeItem('usuario_logado');
                    location.reload();
                });
            }

            // Navega√ß√£o entre p√°ginas
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navegarParaPagina(this.id.replace('nav-', ''));
                });
            });

            // Configurar sistema de coordenadas
            configurarSistemaCoordenadas();

            // Configurar sistema de materiais
            configurarSistemaMateriais();

            // Carregar dados iniciais
            carregarUsuarios();
            carregarLogs();
        }

        function navegarParaPagina(pagina) {
            // Atualizar navega√ß√£o
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${pagina}`).classList.add('active');

            // Mostrar p√°gina correspondente
            document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`page-${pagina}`).classList.add('active');

            // Carregar dados espec√≠ficos da p√°gina se necess√°rio
            switch(pagina) {
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'coordenadas':
                    carregarCoordenadas();
                    break;
                case 'materiais':
                    inicializarSistemaMateriais();
                    break;
                case 'log':
                    carregarLogs();
                    break;
            }
        }

        // FUN√á√ïES PARA USU√ÅRIOS
        async function carregarUsuarios() {
            try {
                const { data: usuarios, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .order('data_cadastro', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('tbody-usuarios');
                if (usuarios && usuarios.length > 0) {
                    tbody.innerHTML = usuarios.map(usuario => `
                        <tr>
                            <td>${usuario.nome}</td>
                            <td>${usuario.email}</td>
                            <td><span class="role-badge role-${usuario.hierarquia.toLowerCase()}">${usuario.hierarquia}</span></td>
                            <td><span class="status-badge status-${usuario.status}">${usuario.status}</span></td>
                            <td>${new Date(usuario.data_cadastro).toLocaleDateString('pt-BR')}</td>
                            <td class="actions">
                                <button class="action-btn btn-info" onclick="editarUsuario(${usuario.id})">Editar</button>
                                <button class="action-btn btn-danger" onclick="excluirUsuario(${usuario.id})">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Atualizar estat√≠sticas
                    document.getElementById('total-usuarios').textContent = usuarios.length;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div>üë•</div>
                                <p>Nenhum usu√°rio cadastrado</p>
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
            }
        }

        function editarUsuario(id) {
            alert(`Editando usu√°rio ID: ${id}`);
        }

        async function excluirUsuario(id) {
            if (confirm('Tem certeza que deseja excluir este usu√°rio?')) {
                try {
                    const { error } = await supabase
                        .from('usuarios')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Usu√°rio exclu√≠do com sucesso!');
                    carregarUsuarios();
                } catch (error) {
                    console.error('Erro ao excluir usu√°rio:', error);
                    alert('Erro ao excluir usu√°rio: ' + error.message);
                }
            }
        }

        // FUN√á√ïES PARA LOGS
        async function carregarLogs() {
            try {
                // Simular logs - em produ√ß√£o, buscaria do Supabase
                const logs = [
                    {
                        data: new Date().toISOString(),
                        usuario: usuarioLogado?.nome || 'Sistema',
                        tipo: 'info',
                        mensagem: 'Login realizado com sucesso',
                        ip: '192.168.1.1'
                    },
                    {
                        data: new Date(Date.now() - 5 * 60000).toISOString(),
                        usuario: 'Sistema',
                        tipo: 'info',
                        mensagem: 'Sistema inicializado',
                        ip: '127.0.0.1'
                    }
                ];

                const tbody = document.getElementById('tbody-logs');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.data).toLocaleString('pt-BR')}</td>
                        <td>${log.usuario}</td>
                        <td><span class="log-type log-${log.tipo}">${log.tipo.toUpperCase()}</span></td>
                        <td>${log.mensagem}</td>
                        <td>${log.ip}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }

        // =============================================
        // SISTEMA DE COORDENADAS - FUN√á√ïES
        // =============================================

        // Configurar sistema de coordenadas
        function configurarSistemaCoordenadas() {
            // Event listeners espec√≠ficos do sistema de coordenadas
            const btnCopiar = document.getElementById('btn-copiar');
            const btnExcluirCoordenadas = document.getElementById('btn-excluir-coordenadas');
            const searchInput = document.getElementById('search-input');
            const tipoLocalSelect = document.getElementById('tipo-local-select');
            const btnLimparPesquisa = document.getElementById('btn-limpar-pesquisa');

            if (btnCopiar) {
                btnCopiar.addEventListener('click', copiarItensSelecionados);
            }

            if (btnExcluirCoordenadas) {
                btnExcluirCoordenadas.addEventListener('click', function() {
                    if (coordenadasSelecionadas.length === 0) {
                        mostrarToast('Por favor, selecione pelo menos uma coordenada para excluir.', 'erro');
                        return;
                    }

                    const coordenadasSelecionadasNomes = [];
                    coordenadasSelecionadas.forEach(id => {
                        const checkbox = document.querySelector(`.item-checkbox[data-id="${id}"]`);
                        if (checkbox) {
                            const nome = checkbox.getAttribute('data-nome');
                            coordenadasSelecionadasNomes.push(nome);
                        }
                    });

                    if (confirm(`Tem certeza que deseja excluir as seguintes coordenadas?\n\n${coordenadasSelecionadasNomes.join('\n')}`)) {
                        excluirMultiplasCoordenadas(coordenadasSelecionadas);
                    }
                });
            }

            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        const termo = searchInput.value.trim();
                        if (termo) {
                            atualizarTabela(termo);
                        } else {
                            modoPesquisaContexto = false;
                            itemPesquisadoIndex = -1;
                            atualizarTabela('');
                        }
                    }, 500);
                });
            }

            if (tipoLocalSelect) {
                let searchTimeout;
                tipoLocalSelect.addEventListener('change', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        const termo = searchInput.value.trim();
                        atualizarTabela(termo);
                    }, 300);
                });
            }

            if (btnLimparPesquisa) {
                btnLimparPesquisa.addEventListener('click', function() {
                    searchInput.value = '';
                    tipoLocalSelect.value = '';
                    paginaAtual = 1;
                    modoPesquisaContexto = false;
                    itemPesquisadoIndex = -1;
                    atualizarTabela();
                });
            }

            // Inicializar sistema de coordenadas
            inicializarSistemaCoordenadas();
        }

        // Inicializar sistema de coordenadas
        async function inicializarSistemaCoordenadas() {
            console.log('üìç Inicializando sistema de coordenadas...');
            
            // Detectar a coluna de ID
            await descobrirColunaIdCoordenadas();
            
            // Carregar tipos de local
            await carregarTiposDeLocal();
        }

        // CORRE√á√ÉO: Fun√ß√£o otimizada para descobrir a coluna de ID
        async function descobrirColunaIdCoordenadas() {
            if (colunaIdCoordenadas) {
                return colunaIdCoordenadas;
            }
            
            try {
                console.log('üîç Detectando coluna de ID da tabela coordenadas...');
                
                const { data, error } = await supabase
                    .from(TABELA_COORDENADAS)
                    .select('*')
                    .limit(1);

                if (error) throw error;
                
                if (data && data.length > 0) {
                    const primeiraCoordenada = data[0];
                    console.log('Estrutura da coordenada:', primeiraCoordenada);
                    
                    const possiveisIds = ['id', 'ID', 'Id', 'codigo', 'cod', 'chave'];
                    for (const possivelId of possiveisIds) {
                        if (primeiraCoordenada.hasOwnProperty(possivelId)) {
                            console.log(`‚úÖ Coluna de ID encontrada: ${possivelId}`);
                            colunaIdCoordenadas = possivelId;
                            return possivelId;
                        }
                    }
                    
                    const primeiraChave = Object.keys(primeiraCoordenada)[0];
                    console.log(`‚ö†Ô∏è Usando primeira chave como ID: ${primeiraChave}`);
                    colunaIdCoordenadas = primeiraChave;
                    return primeiraChave;
                }
                
                console.warn('‚ùå N√£o foi poss√≠vel identificar a coluna de ID, usando "id" como padr√£o');
                colunaIdCoordenadas = 'id';
                return 'id';
            } catch (error) {
                console.error('‚ùå Erro ao identificar coluna de ID:', error);
                colunaIdCoordenadas = 'id';
                return 'id';
            }
        }

        // Fun√ß√£o para normalizar coordenadas (substituir v√≠rgula por ponto)
        function normalizarCoordenada(valor) {
            if (!valor) return '';
            return valor.toString().replace(',', '.');
        }

        // Fun√ß√µes de CRUD para Coordenadas
        async function obterTodasCoordenadas() {
            console.log('üîç Buscando TODOS os dados do Supabase...');
            
            let todasCoordenadas = [];
            let inicio = 0;
            const limite = 1000;
            let hasMore = true;
            
            try {
                while (hasMore) {
                    console.log(`üì• Buscando registros ${inicio} a ${inicio + limite - 1}...`);
                    
                    const { data, error } = await supabase
                        .from(TABELA_COORDENADAS)
                        .select('*')
                        .range(inicio, inicio + limite - 1);

                    if (error) {
                        console.error('Erro ao buscar coordenadas:', error);
                        break;
                    }

                    if (data && data.length > 0) {
                        todasCoordenadas = todasCoordenadas.concat(data);
                        console.log(`‚úÖ ${data.length} registros carregados. Total: ${todasCoordenadas.length}`);
                        
                        if (data.length < limite) {
                            hasMore = false;
                            console.log('üèÅ Todos os registros foram carregados.');
                        } else {
                            inicio += limite;
                        }
                    } else {
                        hasMore = false;
                        console.log('üèÅ Nenhum registro adicional encontrado.');
                    }
                }
                
                console.log(`‚úÖ ${todasCoordenadas.length} coordenadas carregadas no total`);
                return todasCoordenadas;
            } catch (error) {
                console.error('Erro ao buscar todas as coordenadas:', error);
                return [];
            }
        }

        async function obterCoordenadas() {
            document.getElementById('loading-coordenadas').classList.remove('hidden');
            document.getElementById('tabela-coordenadas').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('pagination-controls').classList.add('hidden');
            document.getElementById('pagination-info').classList.add('hidden');
            document.getElementById('stats-info').classList.add('hidden');
            
            try {
                const data = await obterTodasCoordenadas();
                console.log(`‚úÖ ${data ? data.length : 0} coordenadas carregadas`);
                
                const statsText = document.getElementById('stats-text');
                const total = data.length;
                if (statsText) {
                    statsText.innerHTML = `<strong>Total carregado:</strong> ${total} registros`;
                }
                
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar coordenadas:', error);
                return [];
            } finally {
                document.getElementById('loading-coordenadas').classList.add('hidden');
            }
        }

        async function obterTiposDeLocal() {
            try {
                console.log('üîç Buscando tipos de local...');
                
                const data = await obterTodasCoordenadas();

                const tiposComContagem = {};
                
                data.forEach(item => {
                    const tipoLocal = item['Tipo de Local'] || item['tipo_local'] || item['Tipo_de_Local'] || item['tipo'] || item['Tipo'] || '';
                    if (tipoLocal && tipoLocal.trim() !== '') {
                        if (!tiposComContagem[tipoLocal]) {
                            tiposComContagem[tipoLocal] = 0;
                        }
                        tiposComContagem[tipoLocal]++;
                    }
                });
                
                const tiposArray = Object.keys(tiposComContagem).map(tipo => ({
                    tipo: tipo,
                    count: tiposComContagem[tipo]
                })).sort((a, b) => a.tipo.localeCompare(b.tipo));
                
                console.log(`‚úÖ ${tiposArray.length} tipos de local encontrados com contagem`);
                
                return tiposArray;
            } catch (error) {
                console.error('Erro ao buscar tipos de local:', error);
                return [];
            }
        }

        async function carregarTiposDeLocal() {
            const tipoLocalSelect = document.getElementById('tipo-local-select');
            
            try {
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = 'Carregando tipos...';
                tipoLocalSelect.innerHTML = '';
                tipoLocalSelect.appendChild(loadingOption);
                
                const tiposComContagem = await obterTiposDeLocal();
                const todasCoordenadas = await obterTodasCoordenadas();
                const totalTodos = todasCoordenadas.length;
                
                tipoLocalSelect.innerHTML = '';
                
                const optionTodos = document.createElement('option');
                optionTodos.value = '';
                optionTodos.innerHTML = `Todos os Tipos de Local <span class="option-count">(${totalTodos})</span>`;
                tipoLocalSelect.appendChild(optionTodos);
                
                tiposComContagem.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.tipo;
                    option.innerHTML = `${item.tipo} <span class="option-count">(${item.count})</span>`;
                    tipoLocalSelect.appendChild(option);
                });
                
                tiposDeLocalCache = tiposComContagem;
                
                console.log(`‚úÖ ${tiposComContagem.length} tipos de local carregados com contagem`);
            } catch (error) {
                console.error('Erro ao carregar tipos de local:', error);
                tipoLocalSelect.innerHTML = '<option value="">Todos os Tipos de Local</option>';
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para excluir m√∫ltiplas coordenadas usando a coluna de ID correta
        async function excluirMultiplasCoordenadas(ids) {
            try {
                const colunaId = await descobrirColunaIdCoordenadas();
                console.log(`üóëÔ∏è Excluindo coordenadas usando a coluna: ${colunaId}`);
                console.log(`üóëÔ∏è IDs para excluir:`, ids);
                
                const result = await supabase
                    .from(TABELA_COORDENADAS)
                    .delete()
                    .in(colunaId, ids);

                if (result.error) {
                    if (result.error.message.includes('row-level security policy')) {
                        console.error('‚ùå Erro de RLS detectado:', result.error);
                        mostrarToast('Erro de permiss√£o: A tabela est√° protegida por pol√≠ticas de seguran√ßa. Entre em contato com o administrador.', 'erro');
                    }
                    throw result.error;
                }
                
                mostrarToast(`‚úÖ ${ids.length} coordenada(s) exclu√≠da(s) com sucesso!`);
                atualizarTabela();
                return true;
            } catch (error) {
                console.error('Erro ao excluir coordenadas:', error);
                mostrarToast('Erro ao excluir coordenadas: ' + error.message, 'erro');
                return false;
            }
        }

        // Fun√ß√µes de Pagina√ß√£o
        function atualizarPaginacao() {
            const paginationControls = document.getElementById('pagination-controls');
            const paginationInfo = document.getElementById('pagination-info');
            const statsInfo = document.getElementById('stats-info');
            const totalItens = coordenadasFiltradas.length;
            const totalPaginas = Math.ceil(totalItens / itensPorPagina);
            
            paginationControls.innerHTML = '';
            
            if (totalPaginas <= 1) {
                paginationControls.classList.add('hidden');
                paginationInfo.classList.add('hidden');
                statsInfo.classList.remove('hidden');
                return;
            }
            
            paginationControls.classList.remove('hidden');
            paginationInfo.classList.remove('hidden');
            statsInfo.classList.remove('hidden');
            
            const btnAnterior = document.createElement('button');
            btnAnterior.innerHTML = '&laquo; Anterior';
            btnAnterior.disabled = paginaAtual === 1;
            btnAnterior.addEventListener('click', () => {
                if (paginaAtual > 1) {
                    paginaAtual--;
                    renderizarPagina();
                }
            });
            paginationControls.appendChild(btnAnterior);
            
            const inicioPagina = Math.max(1, paginaAtual - 2);
            const fimPagina = Math.min(totalPaginas, paginaAtual + 2);
            
            for (let i = inicioPagina; i <= fimPagina; i++) {
                const btnPagina = document.createElement('button');
                btnPagina.textContent = i;
                if (i === paginaAtual) {
                    btnPagina.classList.add('active');
                }
                btnPagina.addEventListener('click', () => {
                    paginaAtual = i;
                    renderizarPagina();
                });
                paginationControls.appendChild(btnPagina);
            }
            
            const btnProximo = document.createElement('button');
            btnProximo.innerHTML = 'Pr√≥ximo &raquo;';
            btnProximo.disabled = paginaAtual === totalPaginas;
            btnProximo.addEventListener('click', () => {
                if (paginaAtual < totalPaginas) {
                    paginaAtual++;
                    renderizarPagina();
                }
            });
            paginationControls.appendChild(btnProximo);
            
            const inicioItem = (paginaAtual - 1) * itensPorPagina + 1;
            const fimItem = Math.min(paginaAtual * itensPorPagina, totalItens);
            
            paginationInfo.textContent = `Mostrando ${inicioItem} a ${fimItem} de ${totalItens} coordenadas`;
            paginationInfo.classList.remove('hidden');
        }

        // Fun√ß√£o renderizarPagina
        function renderizarPagina() {
            const tabelaCorpo = document.getElementById('tabela-corpo');
            const emptyState = document.getElementById('empty-state');
            const infoPesquisa = document.getElementById('info-pesquisa');
            
            let coordsPagina = [];
            let inicio = 0;
            let fim = 0;
            
            if (modoPesquisaContexto) {
                coordsPagina = coordenadasFiltradas;
                inicio = 1;
                fim = coordsPagina.length;
            } else {
                inicio = (paginaAtual - 1) * itensPorPagina;
                fim = inicio + itensPorPagina;
                coordsPagina = coordenadasFiltradas.slice(inicio, fim);
            }
            
            tabelaCorpo.innerHTML = '';
            
            if (coordsPagina.length === 0) {
                document.getElementById('tabela-coordenadas').classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
                document.getElementById('pagination-info').classList.add('hidden');
                document.getElementById('stats-info').classList.add('hidden');
                if (infoPesquisa) infoPesquisa.classList.add('hidden');
                return;
            } else {
                document.getElementById('tabela-coordenadas').classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
            
            const colunaId = colunaIdCoordenadas || 'id';
            
            coordsPagina.forEach((coord, index) => {
                const tr = document.createElement('tr');
                
                const nome = coord.Nome || '';
                const tipoLocal = coord['Tipo de Local'] || coord['tipo_local'] || coord['Tipo_de_Local'] || coord['tipo'] || coord['Tipo'] || '';
                const latitude = normalizarCoordenada(coord.Y);
                const longitude = normalizarCoordenada(coord.X);
                const idCoordenada = coord[colunaId] || '';
                
                tr.innerHTML = `
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" data-id="${idCoordenada}" data-nome="${nome}" data-latitude="${latitude}" data-longitude="${longitude}">
                    </td>
                    <td>${nome}</td>
                    <td>${tipoLocal}</td>
                    <td>${latitude}</td>
                    <td>${longitude}</td>
                `;
                tabelaCorpo.appendChild(tr);
                
                const checkbox = tr.querySelector('.item-checkbox');
                checkbox.addEventListener('change', function() {
                    const coordId = this.getAttribute('data-id');
                    alternarSelecaoCoordenada(coordId, this.closest('tr'));
                });
            });
            
            if (!modoPesquisaContexto) {
                atualizarPaginacao();
            } else {
                document.getElementById('pagination-controls').classList.add('hidden');
                document.getElementById('pagination-info').classList.add('hidden');
                document.getElementById('stats-info').classList.remove('hidden');
            }
        }

        function gerarTextoParaCopiar() {
            const checkboxesSelecionados = document.querySelectorAll('.item-checkbox:checked');
            let texto = '';
            
            checkboxesSelecionados.forEach(checkbox => {
                const nome = checkbox.getAttribute('data-nome');
                const latitude = checkbox.getAttribute('data-latitude');
                const longitude = checkbox.getAttribute('data-longitude');
                
                texto += `*Localiza√ß√£o aproximada da ${nome}:*\n`;
                texto += `https://www.google.com/maps/place/${latitude},${longitude}\n\n`;
            });
            
            return texto.trim();
        }

        function copiarParaAreaDeTransferencia(texto) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(texto);
            } else {
                return new Promise((resolve, reject) => {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('Falha ao copiar texto'));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }

        function mostrarToast(mensagem, tipo = 'sucesso') {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.className = 'toast';
            
            if (tipo === 'erro') {
                toast.classList.add('error');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Fun√ß√µes de UI (User Interface)
        function atualizarBotoesAcao() {
            const btnExcluirCoordenadas = document.getElementById('btn-excluir-coordenadas');
            
            if (coordenadasSelecionadas.length > 0) {
                btnExcluirCoordenadas.classList.remove('hidden');
            } else {
                btnExcluirCoordenadas.classList.add('hidden');
            }
        }

        function alternarSelecaoCoordenada(coordId, coordElement) {
            const index = coordenadasSelecionadas.indexOf(coordId);
            
            if (index === -1) {
                coordenadasSelecionadas.push(coordId);
            } else {
                coordenadasSelecionadas.splice(index, 1);
            }
            
            atualizarBotoesAcao();
        }

        function copiarItensSelecionados() {
            const checkboxesSelecionados = document.querySelectorAll('.item-checkbox:checked');
            
            if (checkboxesSelecionados.length === 0) {
                mostrarToast('Por favor, selecione pelo menos um item para copiar.', 'erro');
                return;
            }
            
            const texto = gerarTextoParaCopiar();
            
            copiarParaAreaDeTransferencia(texto).then(() => {
                mostrarToast('Texto copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Erro ao copiar texto: ', err);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    mostrarToast('Texto copiado para a √°rea de transfer√™ncia!');
                } catch (err2) {
                    console.error('Erro ao copiar texto (m√©todo alternativo): ', err2);
                    mostrarToast('Erro ao copiar texto. Tente novamente.', 'erro');
                }
            });
        }

        // Fun√ß√£o atualizarTabela
        async function atualizarTabela(termoPesquisa = '') {
            const coordenadas = await obterCoordenadas();
            const tipoLocalSelecionado = document.getElementById('tipo-local-select').value;
            
            coordenadasFiltradas = coordenadas;
            if (termoPesquisa || tipoLocalSelecionado) {
                const termo = termoPesquisa.toLowerCase();
                
                coordenadasFiltradas = coordenadas.filter(coord => {
                    const nome = coord.Nome || '';
                    const tipoLocal = coord['Tipo de Local'] || coord['tipo_local'] || coord['Tipo_de_Local'] || coord['tipo'] || coord['Tipo'] || '';
                    
                    const correspondePesquisa = !termoPesquisa || 
                        nome.toLowerCase().includes(termo) ||
                        tipoLocal.toLowerCase().includes(termo);
                    
                    const correspondeTipoLocal = !tipoLocalSelecionado || 
                        tipoLocal === tipoLocalSelecionado;
                    
                    return correspondePesquisa && correspondeTipoLocal;
                });
            }
            
            coordenadasSelecionadas = [];
            atualizarBotoesAcao();
            
            if (!modoPesquisaContexto) {
                paginaAtual = 1;
            }
            
            renderizarPagina();
            
            document.getElementById('total-coordenadas').textContent = coordenadas.length;
        }

        // Carregar coordenadas (fun√ß√£o principal)
        async function carregarCoordenadas() {
            console.log('üìç Carregando coordenadas...');
            await atualizarTabela();
        }

        // =============================================
        // SISTEMA DE MATERIAIS - FUN√á√ïES COMPLETAS
        // =============================================

        // Configurar sistema de materiais
        function configurarSistemaMateriais() {
            // Configurar tabs
            document.querySelectorAll('.tab-materiais').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    alternarTabMateriais(tabId);
                });
            });

            // Configurar bot√µes de pesquisa
            document.getElementById('searchButtonMateriais').addEventListener('click', function() {
                pesquisarMateriais();
            });

            // Configurar limpar pesquisa
            document.getElementById('clearSearchMateriais').addEventListener('click', function() {
                document.getElementById('searchInputMateriais').value = '';
                this.style.display = 'none';
                pesquisarMateriais();
            });

            // Configurar selecionar todos
            document.getElementById('selectAllMateriais').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#resultsBodyMateriais input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const codigo = checkbox.getAttribute('data-codigo');
                    if (this.checked) {
                        selectedItemsMateriais.add(codigo);
                    } else {
                        selectedItemsMateriais.delete(codigo);
                    }
                });
                atualizarInfoSelecaoMateriais();
            });

            // Configurar copiar selecionados
            document.getElementById('copySelectedMateriais').addEventListener('click', function() {
                copiarMateriaisSelecionados();
            });

            // Configurar formul√°rio de material
            document.getElementById('materialForm').addEventListener('submit', function(e) {
                e.preventDefault();
                salvarMaterial();
            });

            // Configurar bot√£o cancelar
            document.getElementById('cancelButtonMateriais').addEventListener('click', function() {
                resetarFormularioMaterial();
            });

            // Configurar adicionar categoria
            document.getElementById('addCategoria').addEventListener('click', function() {
                adicionarCategoria();
            });

            // Configurar t√©cnico para solicita√ß√£o
            document.getElementById('tecnico').addEventListener('change', function() {
                atualizarPreviewEmail();
            });

            // Configurar enviar para Outlook
            document.getElementById('enviarOutlook').addEventListener('click', function() {
                abrirOutlook();
            });

            // Configurar campo de busca com debounce
            document.getElementById('searchInputMateriais').addEventListener('input', function() {
                const clearBtn = document.getElementById('clearSearchMateriais');
                clearBtn.style.display = this.value ? 'block' : 'none';
                
                clearTimeout(searchTimeoutMateriais);
                searchTimeoutMateriais = setTimeout(() => {
                    pesquisarMateriais();
                }, 500);
            });

            // Configurar valida√ß√µes
            document.getElementById('codigo').addEventListener('blur', validarCodigo);
            document.getElementById('descricao').addEventListener('blur', validarDescricao);
            document.getElementById('categoria').addEventListener('change', validarCategoria);
        }

        // Inicializar sistema de materiais
        async function inicializarSistemaMateriais() {
            console.log('üì¶ Inicializando sistema de materiais...');
            
            try {
                // Carregar categorias
                await carregarCategorias();
                
                // Carregar materiais
                await carregarMateriais();
                
                // Carregar t√©cnicos
                carregarTecnicos();
                
                // Inicializar hist√≥rico
                await carregarHistoricoMateriais();
                
                console.log('‚úÖ Sistema de materiais inicializado com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema de materiais:', error);
                mostrarStatusMateriais('Erro ao carregar sistema de materiais: ' + error.message, 'error');
            }
        }

        // CORRE√á√ÉO: Fun√ß√£o para carregar materiais do banco de dados usando os nomes corretos das colunas
        async function carregarMateriais() {
            try {
                console.log('üì¶ Carregando materiais do banco...');
                
                const { data, error } = await supabase
                    .from(TABELA_MATERIAIS)
                    .select('*')
                    .order('C√≥digo', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao carregar materiais:', error);
                    throw error;
                }

                materiais = data || [];
                console.log(`‚úÖ ${materiais.length} materiais carregados`);
                
                // Atualizar estat√≠sticas
                document.getElementById('total-materiais').textContent = materiais.length;
                
                // Atualizar interface
                exibirMateriais(materiais);
                
                return materiais;
            } catch (error) {
                console.error('‚ùå Erro ao carregar materiais:', error);
                mostrarStatusMateriais('Erro ao carregar materiais: ' + error.message, 'error');
                return [];
            }
        }

        // Exibir materiais na tabela
        function exibirMateriais(listaMateriais, pagina = 1) {
            const tbody = document.getElementById('resultsBodyMateriais');
            const pagination = document.getElementById('paginationMateriais');
            
            if (!listaMateriais || listaMateriais.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-results-materiais">
                            <i class="fas fa-box-open"></i> Nenhum material encontrado
                        </td>
                    </tr>
                `;
                pagination.innerHTML = '';
                return;
            }
            
            // Pagina√ß√£o
            const totalPages = Math.ceil(listaMateriais.length / itemsPerPageMateriais);
            const startIndex = (pagina - 1) * itemsPerPageMateriais;
            const endIndex = startIndex + itemsPerPageMateriais;
            const materiaisPagina = listaMateriais.slice(startIndex, endIndex);
            
            tbody.innerHTML = materiaisPagina.map(material => {
                const codigo = material['C√≥digo'] || '';
                const descricao = material['Descri√ß√£o'] || '';
                const observacoes = material['Observa√ß√µes'] || '';
                const categoria = material['Categoria'] || '';
                const isSelected = selectedItemsMateriais.has(codigo);
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="item-checkbox-material" 
                                   data-codigo="${codigo}" 
                                   ${isSelected ? 'checked' : ''}>
                        </td>
                        <td>${codigo}</td>
                        <td>${descricao}</td>
                        <td>${observacoes || '-'}</td>
                        <td>${categoria}</td>
                        <td class="categoria-actions-materiais">
                            <button class="btn-edit-materiais" onclick="editarMaterial('${codigo}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-delete-materiais" onclick="excluirMaterial('${codigo}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            <button class="btn-info add-solicitacao" onclick="adicionarSolicitacaoMaterial('${codigo}')">
                                <i class="fas fa-plus"></i> Solicitar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Atualizar pagina√ß√£o
            atualizarPaginacaoMateriais(totalPages, pagina);
            
            // Adicionar event listeners aos checkboxes
            document.querySelectorAll('.item-checkbox-material').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const codigo = this.getAttribute('data-codigo');
                    if (this.checked) {
                        selectedItemsMateriais.add(codigo);
                    } else {
                        selectedItemsMateriais.delete(codigo);
                    }
                    atualizarInfoSelecaoMateriais();
                });
            });
        }

        // Atualizar pagina√ß√£o de materiais
        function atualizarPaginacaoMateriais(totalPages, currentPage) {
            const pagination = document.getElementById('paginationMateriais');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Bot√£o anterior
            if (currentPage > 1) {
                paginationHTML += `<button onclick="mudarPaginaMateriais(${currentPage - 1})">&laquo; Anterior</button>`;
            }
            
            // P√°ginas
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="mudarPaginaMateriais(${i})">${i}</button>`;
                }
            }
            
            // Bot√£o pr√≥ximo
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="mudarPaginaMateriais(${currentPage + 1})">Pr√≥ximo &raquo;</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        // Mudar p√°gina de materiais
        function mudarPaginaMateriais(pagina) {
            currentPageMateriais = pagina;
            pesquisarMateriais();
        }

        // Atualizar informa√ß√µes de sele√ß√£o
        function atualizarInfoSelecaoMateriais() {
            const selectionInfo = document.getElementById('selectionInfoMateriais');
            const copyButton = document.getElementById('copySelectedMateriais');
            const selectAll = document.getElementById('selectAllMateriais');
            
            if (selectedItemsMateriais.size > 0) {
                selectionInfo.textContent = `${selectedItemsMateriais.size} item(s) selecionado(s)`;
                copyButton.disabled = false;
            } else {
                selectionInfo.textContent = 'Nenhum item selecionado';
                copyButton.disabled = true;
            }
            
            // Atualizar checkbox "Selecionar todos"
            const totalCheckboxes = document.querySelectorAll('#resultsBodyMateriais input[type="checkbox"]').length;
            const checkedCheckboxes = document.querySelectorAll('#resultsBodyMateriais input[type="checkbox"]:checked').length;
            
            selectAll.checked = checkedCheckboxes === totalCheckboxes && totalCheckboxes > 0;
            selectAll.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
        }

        // Copiar materiais selecionados
        function copiarMateriaisSelecionados() {
            if (selectedItemsMateriais.size === 0) {
                mostrarStatusMateriais('Nenhum material selecionado para copiar', 'warning');
                return;
            }
            
            const materiaisSelecionados = materiais.filter(m => selectedItemsMateriais.has(m['C√≥digo']));
            const texto = materiaisSelecionados.map(m => 
                `${m['C√≥digo']} - ${m['Descri√ß√£o'] || ''}${m['Observa√ß√µes'] ? ` (${m['Observa√ß√µes']})` : ''}`
            ).join('\n');
            
            copiarParaAreaDeTransferencia(texto).then(() => {
                mostrarStatusMateriais(`${selectedItemsMateriais.size} material(is) copiado(s) para a √°rea de transfer√™ncia`, 'success');
                adicionarHistoricoMateriais(`${selectedItemsMateriais.size} item(ns) copiado(s) para √°rea de transfer√™ncia`, 'Sistema');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                mostrarStatusMateriais('Erro ao copiar materiais', 'error');
            });
        }

        // Pesquisar materiais
        function pesquisarMateriais() {
            const termo = document.getElementById('searchInputMateriais').value.toLowerCase();
            const categoria = document.getElementById('categoryFilterMateriais').value;
            
            let resultados = materiais;
            
            // Aplicar filtros
            if (termo) {
                resultados = resultados.filter(m => {
                    const codigo = (m['C√≥digo'] || '').toString().toLowerCase();
                    const descricao = (m['Descri√ß√£o'] || '').toLowerCase();
                    const observacoes = (m['Observa√ß√µes'] || '').toLowerCase();
                    
                    return codigo.includes(termo) ||
                           descricao.includes(termo) ||
                           observacoes.includes(termo);
                });
            }
            
            if (categoria) {
                resultados = resultados.filter(m => (m['Categoria'] || '') === categoria);
            }
            
            // Exibir resultados
            exibirMateriais(resultados, currentPageMateriais);
            
            // Atualizar informa√ß√µes de sele√ß√£o
            atualizarInfoSelecaoMateriais();
        }

        // CORRE√á√ÉO: Fun√ß√£o para carregar categorias
        async function carregarCategorias() {
            try {
                console.log('üè∑Ô∏è Carregando categorias...');
                
                const { data, error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) {
                    console.error('‚ùå Erro ao carregar categorias:', error);
                    throw error;
                }

                categorias = data || [];
                console.log(`‚úÖ ${categorias.length} categorias carregadas`);
                
                // Atualizar selects de categoria
                atualizarSelectsCategoria();
                
                return categorias;
            } catch (error) {
                console.error('‚ùå Erro ao carregar categorias:', error);
                mostrarStatusMateriais('Erro ao carregar categorias: ' + error.message, 'error');
                return [];
            }
        }

        // Atualizar selects de categoria
        function atualizarSelectsCategoria() {
            const selectCadastro = document.getElementById('categoria');
            const selectFiltro = document.getElementById('categoryFilterMateriais');
            
            // Limpar selects
            selectCadastro.innerHTML = '<option value="">Selecione uma categoria</option>';
            selectFiltro.innerHTML = '<option value="">Todas as categorias</option>';
            
            // Adicionar categorias
            categorias.forEach(categoria => {
                const optionCadastro = document.createElement('option');
                optionCadastro.value = categoria.nome;
                optionCadastro.textContent = categoria.nome;
                selectCadastro.appendChild(optionCadastro);
                
                const optionFiltro = document.createElement('option');
                optionFiltro.value = categoria.nome;
                optionFiltro.textContent = categoria.nome;
                selectFiltro.appendChild(optionFiltro);
            });
        }

        // Alternar tab de materiais
        function alternarTabMateriais(tabId) {
            // Atualizar tabs
            document.querySelectorAll('.tab-materiais').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content-materiais').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar tab selecionada
            document.querySelector(`.tab-materiais[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // A√ß√µes espec√≠ficas por tab
            if (tabId === 'consultar-materiais') {
                pesquisarMateriais();
            } else if (tabId === 'cadastrar-materiais') {
                resetarFormularioMaterial();
            } else if (tabId === 'categorias-materiais') {
                carregarListaCategorias();
            } else if (tabId === 'solicitacao-materiais') {
                atualizarSolicitacaoMateriais();
            } else if (tabId === 'historico-materiais') {
                carregarHistoricoMateriais();
            }
        }

        // Mostrar status no sistema de materiais
        function mostrarStatusMateriais(mensagem, tipo) {
            const statusElement = document.getElementById('statusMessageMateriais');
            statusElement.textContent = mensagem;
            statusElement.className = `status-message-materiais status-${tipo}-materiais`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Carregar t√©cnicos
        function carregarTecnicos() {
            const selectTecnico = document.getElementById('tecnico');
            selectTecnico.innerHTML = '<option value="">Selecione o t√©cnico</option>';
            
            tecnicos.forEach(tecnico => {
                const option = document.createElement('option');
                option.value = tecnico;
                option.textContent = tecnico;
                selectTecnico.appendChild(option);
            });
        }

        // VALIDA√á√ïES DO FORMUL√ÅRIO
        function validarCodigo() {
            const codigo = document.getElementById('codigo').value.trim();
            const errorElement = document.getElementById('codigoError');
            
            if (codigo === '') {
                mostrarErroValidacao('codigo', errorElement, 'C√≥digo √© obrigat√≥rio');
                return false;
            }
            
            if (!editandoMaterial && materiais.some(m => m['C√≥digo'] === codigo)) {
                mostrarErroValidacao('codigo', errorElement, 'C√≥digo j√° existe');
                return false;
            }
            
            ocultarErroValidacao('codigo', errorElement);
            return true;
        }

        function validarDescricao() {
            const descricao = document.getElementById('descricao').value.trim();
            const errorElement = document.getElementById('descricaoError');
            
            if (descricao === '') {
                mostrarErroValidacao('descricao', errorElement, 'Descri√ß√£o √© obrigat√≥ria');
                return false;
            }
            
            ocultarErroValidacao('descricao', errorElement);
            return true;
        }

        function validarCategoria() {
            const categoria = document.getElementById('categoria').value;
            const errorElement = document.getElementById('categoriaError');
            
            if (categoria === '') {
                mostrarErroValidacao('categoria', errorElement, 'Categoria √© obrigat√≥ria');
                return false;
            }
            
            ocultarErroValidacao('categoria', errorElement);
            return true;
        }

        function mostrarErroValidacao(campoId, errorElement, mensagem) {
            document.getElementById(campoId).classList.add('input-error-materiais');
            errorElement.textContent = mensagem;
            errorElement.style.display = 'block';
        }

        function ocultarErroValidacao(campoId, errorElement) {
            document.getElementById(campoId).classList.remove('input-error-materiais');
            errorElement.style.display = 'none';
        }

        // SALVAR MATERIAL
        async function salvarMaterial() {
            if (!validarCodigo() || !validarDescricao() || !validarCategoria()) {
                mostrarStatusMateriais('Por favor, corrija os erros no formul√°rio', 'error');
                return;
            }
            
            const materialData = {
                'C√≥digo': document.getElementById('codigo').value.trim(),
                'Descri√ß√£o': document.getElementById('descricao').value.trim(),
                'Observa√ß√µes': document.getElementById('observacoes').value.trim(),
                'Categoria': document.getElementById('categoria').value,
                'Data de Cadastro': new Date().toISOString()
            };
            
            try {
                let resultado;
                
                if (editandoMaterial) {
                    // Atualizar material existente
                    resultado = await supabase
                        .from(TABELA_MATERIAIS)
                        .update(materialData)
                        .eq('C√≥digo', codigoEditando);
                        
                    if (resultado.error) throw resultado.error;
                    
                    mostrarStatusMateriais('Material atualizado com sucesso!', 'success');
                    adicionarHistoricoMateriais(`Material "${codigoEditando}" atualizado`, 'Sistema');
                } else {
                    // Inserir novo material
                    resultado = await supabase
                        .from(TABELA_MATERIAIS)
                        .insert([materialData]);
                        
                    if (resultado.error) throw resultado.error;
                    
                    mostrarStatusMateriais('Material cadastrado com sucesso!', 'success');
                    adicionarHistoricoMateriais(`Material "${materialData['C√≥digo']}" cadastrado`, 'Sistema');
                }
                
                // Recarregar materiais e resetar formul√°rio
                await carregarMateriais();
                resetarFormularioMaterial();
                alternarTabMateriais('consultar-materiais');
                
            } catch (error) {
                console.error('Erro ao salvar material:', error);
                mostrarStatusMateriais('Erro ao salvar material: ' + error.message, 'error');
            }
        }

        function resetarFormularioMaterial() {
            document.getElementById('materialForm').reset();
            document.getElementById('formTitleMateriais').innerHTML = '<i class="fas fa-plus-circle"></i> Cadastrar Novo Material';
            document.getElementById('submitButtonMateriais').innerHTML = '<i class="fas fa-save"></i> Cadastrar Material';
            editandoMaterial = false;
            codigoEditando = null;
            
            // Limpar erros de valida√ß√£o
            document.querySelectorAll('.validation-error-materiais').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error-materiais').forEach(el => {
                el.classList.remove('input-error-materiais');
            });
            
            // Habilitar campo c√≥digo
            document.getElementById('codigo').disabled = false;
        }

        async function editarMaterial(codigo) {
            const material = materiais.find(m => m['C√≥digo'] === codigo);
            
            if (material) {
                document.getElementById('codigo').value = material['C√≥digo'];
                document.getElementById('descricao').value = material['Descri√ß√£o'];
                document.getElementById('observacoes').value = material['Observa√ß√µes'] || '';
                document.getElementById('categoria').value = material['Categoria'];
                
                editandoMaterial = true;
                codigoEditando = codigo;
                document.getElementById('formTitleMateriais').innerHTML = '<i class="fas fa-edit"></i> Editar Material';
                document.getElementById('submitButtonMateriais').innerHTML = '<i class="fas fa-save"></i> Atualizar Material';
                
                // Desabilitar campo c√≥digo durante edi√ß√£o
                document.getElementById('codigo').disabled = true;
                
                // Ir para aba de cadastro
                alternarTabMateriais('cadastrar-materiais');
            }
        }

        async function excluirMaterial(codigo) {
            if (!confirm(`Tem certeza que deseja excluir o material "${codigo}"?`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from(TABELA_MATERIAIS)
                    .delete()
                    .eq('C√≥digo', codigo);

                if (error) throw error;
                
                mostrarStatusMateriais('Material exclu√≠do com sucesso!', 'success');
                adicionarHistoricoMateriais(`Material "${codigo}" exclu√≠do`, 'Sistema');
                
                // Recarregar materiais
                await carregarMateriais();
                
                // Remover da solicita√ß√£o se estiver l√°
                solicitacaoItemsMateriais.delete(codigo);
                atualizarSolicitacaoMateriais();
                
            } catch (error) {
                console.error('Erro ao excluir material:', error);
                mostrarStatusMateriais('Erro ao excluir material: ' + error.message, 'error');
            }
        }

        // GERENCIAMENTO DE CATEGORIAS
        async function carregarListaCategorias() {
            const categoriasList = document.getElementById('categoriasList');
            
            try {
                await carregarCategorias();
                
                if (categorias.length === 0) {
                    categoriasList.innerHTML = '<p>Nenhuma categoria cadastrada.</p>';
                    return;
                }
                
                categoriasList.innerHTML = categorias.map((categoria, index) => {
                    if (editandoCategoriaIndex === index) {
                        return `
                            <div class="categoria-item">
                                <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                    <input type="text" class="categoria-edit-input" value="${categoria.nome}" 
                                           id="categoriaEditInput-${index}" style="flex: 1;">
                                    <div class="categoria-actions">
                                        <button class="btn btn-save-materiais" onclick="salvarEdicaoCategoria(${index})">
                                            <i class="fas fa-check"></i> Salvar
                                        </button>
                                        <button class="btn btn-secondary-materiais" onclick="cancelarEdicaoCategoria()">
                                            <i class="fas fa-times"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="categoria-item">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <span>${categoria.nome}</span>
                                    <div class="categoria-actions">
                                        <button class="btn btn-edit-materiais" onclick="iniciarEdicaoCategoria(${index})">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        <button class="btn btn-delete-materiais" onclick="excluirCategoria(${index})">
                                            <i class="fas fa-trash"></i> Excluir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista de categorias:', error);
                categoriasList.innerHTML = '<p>Erro ao carregar categorias.</p>';
            }
        }

        function iniciarEdicaoCategoria(index) {
            editandoCategoriaIndex = index;
            carregarListaCategorias();
        }

        function cancelarEdicaoCategoria() {
            editandoCategoriaIndex = null;
            carregarListaCategorias();
        }

        async function salvarEdicaoCategoria(index) {
            const input = document.getElementById(`categoriaEditInput-${index}`);
            const novoNome = input.value.trim();
            
            if (novoNome === '') {
                mostrarStatusMateriais('O nome da categoria n√£o pode estar vazio.', 'error');
                return;
            }
            
            if (categorias.some((cat, i) => i !== index && cat.nome === novoNome)) {
                mostrarStatusMateriais('J√° existe uma categoria com este nome.', 'error');
                return;
            }
            
            try {
                const nomeAntigo = categorias[index].nome;
                
                const { error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .update({ nome: novoNome })
                    .eq('id', categorias[index].id);

                if (error) throw error;
                
                // Atualizar materiais que usam esta categoria
                const { error: errorMateriais } = await supabase
                    .from(TABELA_MATERIAIS)
                    .update({ 'Categoria': novoNome })
                    .eq('Categoria', nomeAntigo);

                if (errorMateriais) throw errorMateriais;
                
                mostrarStatusMateriais('Categoria atualizada com sucesso!', 'success');
                adicionarHistoricoMateriais(`Categoria "${nomeAntigo}" alterada para "${novoNome}"`, 'Sistema');
                
                editandoCategoriaIndex = null;
                await carregarCategorias();
                await carregarMateriais();
                carregarListaCategorias();
                
            } catch (error) {
                console.error('Erro ao salvar categoria:', error);
                mostrarStatusMateriais('Erro ao salvar categoria: ' + error.message, 'error');
            }
        }

        async function excluirCategoria(index) {
            const categoria = categorias[index];
            
            // Verificar se h√° materiais usando esta categoria
            const materiaisNaCategoria = materiais.filter(m => m['Categoria'] === categoria.nome);
            
            if (materiaisNaCategoria.length > 0) {
                mostrarStatusMateriais(`N√£o √© poss√≠vel excluir a categoria "${categoria.nome}" porque existem ${materiaisNaCategoria.length} material(is) vinculado(s) a ela.`, 'error');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja excluir a categoria "${categoria.nome}"?`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .delete()
                    .eq('id', categoria.id);

                if (error) throw error;
                
                mostrarStatusMateriais('Categoria exclu√≠da com sucesso!', 'success');
                adicionarHistoricoMateriais(`Categoria "${categoria.nome}" exclu√≠da`, 'Sistema');
                
                await carregarCategorias();
                carregarListaCategorias();
                
            } catch (error) {
                console.error('Erro ao excluir categoria:', error);
                mostrarStatusMateriais('Erro ao excluir categoria: ' + error.message, 'error');
            }
        }

        async function adicionarCategoria() {
            const novaCategoriaInput = document.getElementById('novaCategoria');
            const novaCategoria = novaCategoriaInput.value.trim();
            
            if (novaCategoria === '') {
                mostrarStatusMateriais('Digite o nome da nova categoria.', 'error');
                return;
            }
            
            if (categorias.some(cat => cat.nome === novaCategoria)) {
                mostrarStatusMateriais('J√° existe uma categoria com este nome.', 'error');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from(TABELA_CATEGORIAS)
                    .insert([{ nome: novaCategoria }]);

                if (error) throw error;
                
                mostrarStatusMateriais('Categoria adicionada com sucesso!', 'success');
                adicionarHistoricoMateriais(`Categoria "${novaCategoria}" adicionada`, 'Sistema');
                
                novaCategoriaInput.value = '';
                await carregarCategorias();
                carregarListaCategorias();
                
            } catch (error) {
                console.error('Erro ao adicionar categoria:', error);
                mostrarStatusMateriais('Erro ao adicionar categoria: ' + error.message, 'error');
            }
        }

        // SOLICITA√á√ÉO DE MATERIAIS
        function adicionarSolicitacaoMaterial(codigo) {
            solicitacaoItemsMateriais.set(codigo, 1);
            atualizarSolicitacaoMateriais();
            mostrarTooltipMateriais('Item adicionado √† solicita√ß√£o!');
        }

        function removerSolicitacaoMaterial(codigo) {
            solicitacaoItemsMateriais.delete(codigo);
            atualizarSolicitacaoMateriais();
        }

        function atualizarQuantidadeMaterial(codigo, quantidade) {
            if (quantidade === '' || quantidade === '0') {
                solicitacaoItemsMateriais.delete(codigo);
            } else {
                solicitacaoItemsMateriais.set(codigo, parseInt(quantidade));
            }
            atualizarSolicitacaoMateriais();
        }

        function validarQuantidadeMaterial(input) {
            let valor = input.value.replace(/[^0-9]/g, '');
            
            if (valor.length > 5) {
                valor = valor.substring(0, 5);
            }
            
            input.value = valor;
            
            if (valor === '' || valor === '0') {
                input.classList.add('invalid');
                return false;
            } else {
                input.classList.remove('invalid');
                return true;
            }
        }

        function atualizarSolicitacaoMateriais() {
            const tbody = document.getElementById('solicitacaoResultsBody');
            const selectionInfo = document.getElementById('solicitacaoSelectionInfo');
            const enviarOutlookBtn = document.getElementById('enviarOutlook');
            
            if (solicitacaoItemsMateriais.size === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-results-materiais">
                            <i class="fas fa-info-circle"></i> Nenhum item adicionado √† solicita√ß√£o
                        </td>
                    </tr>
                `;
                selectionInfo.textContent = 'Nenhum item selecionado';
                enviarOutlookBtn.disabled = true;
            } else {
                const materiaisSolicitacao = materiais.filter(m => solicitacaoItemsMateriais.has(m['C√≥digo']));
                
                tbody.innerHTML = materiaisSolicitacao.map(material => {
                    const codigo = material['C√≥digo'];
                    const quantidade = solicitacaoItemsMateriais.get(codigo);
                    return `
                        <tr>
                            <td>
                                <button class="btn btn-delete-materiais" onclick="removerSolicitacaoMaterial('${codigo}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                            <td>
                                <input type="text" class="quantidade-input" 
                                       value="${quantidade}" 
                                       data-codigo="${codigo}"
                                       maxlength="5"
                                       oninput="validarQuantidadeMaterial(this)"
                                       onblur="atualizarQuantidadeMaterial('${codigo}', this.value)">
                            </td>
                            <td>${codigo}</td>
                            <td>${material['Descri√ß√£o']}</td>
                            <td>${material['Categoria']}</td>
                        </tr>
                    `;
                }).join('');
                
                selectionInfo.textContent = `${solicitacaoItemsMateriais.size} item(s) selecionado(s)`;
                enviarOutlookBtn.disabled = !document.getElementById('tecnico').value;
            }
            
            atualizarPreviewEmail();
        }

        function determinarUnidade(material, quantidade) {
            const descricao = material['Descri√ß√£o'].toLowerCase();
            
            // Materiais que devem ser medidos em metros
            if (descricao.includes('cabo') || 
                descricao.includes('fio') || 
                descricao.includes('fibra') ||
                descricao.includes('conector') ||
                descricao.includes('adaptador')) {
                return quantidade === 1 ? 'metro' : 'metros';
            }
            
            // Para todos os outros casos, usar unidades
            return quantidade === 1 ? 'unidade' : 'unidades';
        }

        function atualizarPreviewEmail() {
            const tecnico = document.getElementById('tecnico').value;
            const materiaisSolicitacao = materiais.filter(m => solicitacaoItemsMateriais.has(m['C√≥digo']));
            const emailAssunto = document.getElementById('emailAssunto');
            const emailPreview = document.getElementById('emailPreview');
            const enviarOutlookBtn = document.getElementById('enviarOutlook');
            
            if (!tecnico || materiaisSolicitacao.length === 0) {
                emailAssunto.textContent = 'Solicita√ß√£o de material - ';
                emailPreview.textContent = 'Selecione um t√©cnico e itens para visualizar o email.';
                enviarOutlookBtn.disabled = true;
                return;
            }
            
            emailAssunto.textContent = `Solicita√ß√£o de material - ${tecnico}`;
            
            const agora = new Date();
            const hora = agora.getHours();
            let saudacao = '';
            
            if (hora >= 6 && hora < 12) {
                saudacao = 'Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = 'Boa tarde';
            } else {
                saudacao = 'Boa noite';
            }
            
            const textoLiberacao = materiaisSolicitacao.length === 1 ? 
                `Favor liberar o item para o t√©cnico: ${tecnico}.` : 
                `Favor liberar os itens para o t√©cnico: ${tecnico}.`;
            
            let listaItens = '';
            materiaisSolicitacao.forEach(material => {
                const quantidade = solicitacaoItemsMateriais.get(material['C√≥digo']);
                const unidade = determinarUnidade(material, quantidade);
                listaItens += `${quantidade} ${unidade} - ${material['C√≥digo']} - ${material['Descri√ß√£o']}\n`;
            });
            
            const emailTexto = `${saudacao},

${textoLiberacao}

${listaItens}`;
            
            emailPreview.textContent = emailTexto;
            enviarOutlookBtn.disabled = false;
        }

        function abrirOutlook() {
            const tecnico = document.getElementById('tecnico').value;
            const materiaisSolicitacao = materiais.filter(m => solicitacaoItemsMateriais.has(m['C√≥digo']));
            
            if (!tecnico || materiaisSolicitacao.length === 0) {
                mostrarStatusMateriais('Selecione um t√©cnico e pelo menos um item para enviar a solicita√ß√£o.', 'error');
                return;
            }
            
            const agora = new Date();
            const hora = agora.getHours();
            let saudacao = '';
            
            if (hora >= 6 && hora < 12) {
                saudacao = 'Bom dia';
            } else if (hora >= 12 && hora < 18) {
                saudacao = 'Boa tarde';
            } else {
                saudacao = 'Boa noite';
            }
            
            const textoLiberacao = materiaisSolicitacao.length === 1 ? 
                `Favor liberar o item para o t√©cnico: ${tecnico}.` : 
                `Favor liberar os itens para o t√©cnico: ${tecnico}.`;
            
            let listaItens = '';
            materiaisSolicitacao.forEach(material => {
                const quantidade = solicitacaoItemsMateriais.get(material['C√≥digo']);
                const unidade = determinarUnidade(material, quantidade);
                listaItens += `${quantidade} ${unidade} - ${material['C√≥digo']} - ${material['Descri√ß√£o']}\n`;
            });
            
            const assunto = `Solicita√ß√£o de material - ${tecnico}`;
            
            const corpo = `${saudacao},

${textoLiberacao}

${listaItens}`;
            
            const para = 'almoxarifado@sodobrasil.net.br';
            const cc = 'construcao@sodobrasil.net.br';
            
            const assuntoCodificado = encodeURIComponent(assunto);
            const corpoCodificado = encodeURIComponent(corpo);
            
            const mailtoUrl = `mailto:${para}?cc=${cc}&subject=${assuntoCodificado}&body=${corpoCodificado}`;
            
            window.location.href = mailtoUrl;
            
            mostrarStatusMateriais('Email aberto no cliente de email padr√£o!', 'success');
            adicionarHistoricoMateriais(`Solicita√ß√£o de ${materiaisSolicitacao.length} item(ns) enviada para ${tecnico}`, 'Sistema');
            
            // Limpar solicita√ß√£o
            solicitacaoItemsMateriais.clear();
            document.getElementById('tecnico').value = '';
            atualizarSolicitacaoMateriais();
        }

        function mostrarTooltipMateriais(mensagem) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = mensagem;
            tooltip.style.background = '#38a169';
            
            document.body.appendChild(tooltip);
            
            setTimeout(() => {
                if (tooltip.parentNode) {
                    tooltip.parentNode.removeChild(tooltip);
                }
            }, 3000);
        }

        // HIST√ìRICO DE MATERIAIS
        async function carregarHistoricoMateriais() {
            const historyList = document.getElementById('historyList');
            
            try {
                // Buscar hist√≥rico do banco (se existir tabela espec√≠fica)
                // Por enquanto, vamos usar um hist√≥rico local
                let historico = JSON.parse(localStorage.getItem('historico_materiais')) || [];
                
                if (historico.length === 0) {
                    historyList.innerHTML = '<p>Nenhum registro no hist√≥rico.</p>';
                    return;
                }
                
                // Limitar a 100 registros
                const historicoLimitado = historico.slice(0, 100);
                
                historyList.innerHTML = historicoLimitado.map(item => `
                    <div class="history-item">
                        <div>${item.acao}</div>
                        <div class="history-date">${formatarDataHora(item.data)} por ${item.usuario}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                historyList.innerHTML = '<p>Erro ao carregar hist√≥rico.</p>';
            }
        }

        async function adicionarHistoricoMateriais(acao, usuario) {
            try {
                // Buscar hist√≥rico atual
                let historico = JSON.parse(localStorage.getItem('historico_materiais')) || [];
                
                // Adicionar novo registro
                historico.unshift({
                    acao: acao,
                    data: new Date().toISOString(),
                    usuario: usuario || (usuarioLogado ? usuarioLogado.nome : 'Sistema')
                });
                
                // Limitar a 100 registros
                if (historico.length > 100) {
                    historico = historico.slice(0, 100);
                }
                
                // Salvar no localStorage
                localStorage.setItem('historico_materiais', JSON.stringify(historico));
                
                // Atualizar interface se estiver na aba de hist√≥rico
                if (document.getElementById('historico-materiais').classList.contains('active')) {
                    await carregarHistoricoMateriais();
                }
                
            } catch (error) {
                console.error('Erro ao adicionar hist√≥rico:', error);
            }
        }

        function formatarDataHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }
    </script>
</body>
</html>